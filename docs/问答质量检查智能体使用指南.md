# 问答质量检查智能体使用指南

## 📋 概述

本文档介绍基于LangChain和豆包大模型的医美知识库问答质量检查智能体，用于自动检测和修正问答内容的准确性、一致性问题。

**版本**: v1.0.0  
**创建日期**: 2025-10-25  
**适用项目**: 越南医疗整形项目  

---

## 🎯 功能特性

### 核心功能
- ✅ **准确性检查**: 验证医学信息的准确性
- ✅ **一致性检查**: 确保问答匹配度
- ✅ **完整性检查**: 检查答案是否完整
- ✅ **安全性检查**: 验证安全提醒和注意事项
- ✅ **自动修正**: 使用豆包模型自动改进答案
- ✅ **质量评分**: 0-100分的质量评分系统
- ✅ **历史记录**: 完整的修改历史追踪

### 检查维度
1. **问答匹配度**: 答案是否直接回答问题
2. **医学准确性**: 医学信息是否准确专业
3. **内容完整性**: 答案是否完整无遗漏
4. **表达清晰度**: 逻辑是否清晰易懂
5. **安全性**: 是否包含安全提醒

---

## 🏗️ 技术架构

### 核心组件
```
QAQualityAgent (智能体)
├── QAQualityChecker (质量检查器)
├── DoubaoLLMClient (豆包模型客户端)
└── 数据库操作模块
```

### 技术栈
- **Python 3.6+**: 主要开发语言
- **SQLite3**: 数据存储
- **豆包大模型**: doubao-seed-1-6-251015
- **Requests**: HTTP客户端
- **JSON**: 数据交换格式

---

## 🔧 安装配置

### 环境准备
```bash
# 1. 创建日志目录
mkdir -p /root/越南医疗整形项目/logs

# 2. 安装Python依赖（如果网络允许）
pip3 install requests --user

# 3. 给脚本添加执行权限
chmod +x /root/越南医疗整形项目/scripts/qa_quality_checker.py
chmod +x /root/越南医疗整形项目/scripts/quick_qa_check.sh
chmod +x /root/越南医疗整形项目/scripts/run_qa_checker.sh
```

### ⚠️ 重要提醒

**数据安全注意事项：**
- ✅ **直接修改原数据库**：所有修正都直接在原数据库中进行
- ✅ **自动历史记录**：每次修改都会保存到 `knowledge_history` 表
- ⚠️ **建议备份**：运行前可手动备份数据库文件
- 🔄 **可回滚**：通过历史记录表可以查看和恢复修改

```bash
# 可选：运行前备份数据库
cp /root/越南医疗整形项目/backend/data/medical.db /root/越南医疗整形项目/backend/data/medical.db.backup
```

### 豆包API配置
```python
# API配置信息
API_URL = "https://ark.cn-beijing.volces.com/api/v3/chat/completions"
API_KEY = "2249d4c5-2e08-4787-9df6-cf5beee474a5"
MODEL = "doubao-seed-1-6-251015"
```

---

## 🚀 使用方法

### 快速使用（推荐）
```bash
# 快速检查和修正（直接修改原数据库）
cd /root/越南医疗整形项目
./scripts/quick_qa_check.sh

# 测试API连接
python3 scripts/test_doubao_api.py
```

### 基本用法
```bash
# 检查所有问答记录（直接修改原数据库）
cd /root/越南医疗整形项目
python3 scripts/qa_quality_checker.py

# 指定数据库路径
python3 scripts/qa_quality_checker.py --db-path backend/data/medical.db

# 设置批处理参数（推荐小批量）
python3 scripts/qa_quality_checker.py --batch-size 3 --delay 2.0

# 只检查特定分类
python3 scripts/qa_quality_checker.py --category 丰胸
```

### 参数说明
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--db-path` | 数据库文件路径 | `/root/越南医疗整形项目/backend/data/medical.db` |
| `--batch-size` | 批处理大小 | 5 |
| `--delay` | 批次间延迟(秒) | 2.0 |
| `--category` | 指定检查分类 | 无 |

### 高级用法
```bash
# 安全模式（降低API调用频率）
python3 scripts/qa_quality_checker.py --batch-size 3 --delay 3.0

# 只检查丰胸相关问答
python3 scripts/qa_quality_checker.py --category 丰胸

# 使用便捷启动脚本
./scripts/run_qa_checker.sh -s  # 安全模式
./scripts/run_qa_checker.sh -c 丰胸  # 指定分类

# ⚠️ 注意：所有修改都直接在原数据库中进行
```

---

## 📊 输出结果

### 控制台输出
```
开始问答质量检查...
共找到 1828 条问答记录
检查进度: 1/1828 - ID: 1
记录 15 需要修正
记录 15 修正成功
批次完成，等待 2.0 秒...
...
质量检查完成

==================================================
质量检查摘要
==================================================
总检查数: 1828
发现问题: 156
完成修正: 142
错误数量: 14
==================================================
```

### 日志文件
```bash
# 查看运行日志
tail -f /root/越南医疗整形项目/logs/qa_checker.log

# 查看质量报告
ls /root/越南医疗整形项目/logs/qa_quality_report_*.json
```

### 质量报告格式
```json
{
  "timestamp": "2025-10-25T14:30:00",
  "statistics": {
    "total_checked": 1828,
    "issues_found": 156,
    "corrections_made": 142,
    "errors": 14
  },
  "issues_summary": [
    {
      "id": 15,
      "category": "丰胸",
      "question": "术后多久可以恢复瑜伽与普拉提？...",
      "quality_score": 75,
      "issues": [
        {
          "type": "completeness",
          "description": "答案缺少具体的时间节点说明",
          "severity": "medium"
        }
      ]
    }
  ],
  "recommendations": [
    "建议定期运行质量检查以维护知识库质量"
  ]
}
```

---

## 🔍 质量评估标准

### 评分体系
- **90-100分**: 优秀 - 无明显问题
- **80-89分**: 良好 - 轻微问题
- **70-79分**: 一般 - 中等问题，建议修正
- **60-69分**: 较差 - 明显问题，需要修正
- **0-59分**: 很差 - 严重问题，必须修正

### 问题类型
| 类型 | 说明 | 严重程度 |
|------|------|----------|
| `accuracy` | 医学信息不准确 | high |
| `consistency` | 问答不匹配 | high |
| `completeness` | 内容不完整 | medium |
| `clarity` | 表达不清晰 | low |
| `safety` | 缺少安全提醒 | high |

---

## 🛠️ 数据库变更

### 新增历史记录表
```sql
CREATE TABLE IF NOT EXISTS knowledge_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    knowledge_id INTEGER NOT NULL,
    old_answer TEXT,
    new_answer TEXT,
    issues TEXT,
    modified_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (knowledge_id) REFERENCES knowledge (id)
);
```

### 查询修改历史
```sql
-- 查看所有修改记录
SELECT * FROM knowledge_history ORDER BY modified_at DESC;

-- 查看特定记录的修改历史
SELECT * FROM knowledge_history WHERE knowledge_id = 15;

-- 统计修改次数
SELECT COUNT(*) as modification_count FROM knowledge_history;
```

---

## 📈 性能优化

### API调用优化
```python
# 批处理设置
BATCH_SIZE = 5      # 每批处理5条记录
DELAY = 2.0         # 批次间延迟2秒
TIMEOUT = 60        # API超时60秒
TEMPERATURE = 0.3   # 降低随机性
```

### 内存优化
- 分批加载数据，避免一次性加载所有记录
- 及时释放数据库连接
- 使用生成器处理大量数据

### 网络优化
- 设置合理的API调用间隔
- 实现重试机制
- 监控API调用频率

---

## 🚨 故障排除

### 常见问题

#### 1. API调用失败
```bash
# 问题：网络连接超时
# 解决：检查网络连接和API密钥
curl -H "Authorization: Bearer 2249d4c5-2e08-4787-9df6-cf5beee474a5" \
     https://ark.cn-beijing.volces.com/api/v3/chat/completions
```

#### 2. 数据库锁定
```bash
# 问题：database is locked
# 解决：确保没有其他进程在使用数据库
lsof /root/越南医疗整形项目/backend/data/medical.db
```

#### 3. JSON解析错误
```python
# 问题：JSON格式不正确
# 解决：增加错误处理和格式验证
try:
    result = json.loads(response)
except json.JSONDecodeError:
    logger.error(f"JSON解析失败: {response}")
```

### 调试命令
```bash
# 检查脚本语法
python3 -m py_compile scripts/qa_quality_checker.py

# 测试API连接
python3 -c "
from scripts.qa_quality_checker import DoubaoLLMClient
client = DoubaoLLMClient()
result = client.call_api([{'role': 'user', 'content': '测试'}])
print(result)
"

# 检查数据库
sqlite3 backend/data/medical.db ".tables"
sqlite3 backend/data/medical.db "SELECT COUNT(*) FROM knowledge;"
```

---

## 📋 最佳实践

### 运行建议
1. **定期检查**: 建议每周运行一次全量检查
2. **增量检查**: 新增数据后立即运行检查
3. **分类检查**: 可按分类分别检查，降低单次运行时间
4. **备份数据**: 运行前备份数据库

### 监控指标
- API调用成功率
- 质量评分分布
- 修正成功率
- 错误类型统计

### 质量维护
```bash
# 定期运行脚本
# 添加到crontab
0 2 * * 0 cd /root/越南医疗整形项目 && python3 scripts/qa_quality_checker.py >> logs/cron.log 2>&1
```

---

## 🔄 扩展开发

### 自定义检查规则
```python
def custom_medical_check(self, qa_record: QARecord) -> Dict:
    """自定义医学专业检查"""
    # 添加特定的医学术语检查
    # 添加药物名称验证
    # 添加手术风险提醒检查
    pass
```

### 多模型支持
```python
class MultiLLMClient:
    """支持多个大模型的客户端"""
    def __init__(self):
        self.models = {
            'doubao': DoubaoLLMClient(),
            'gpt4': GPT4Client(),
            'claude': ClaudeClient()
        }
```

### API集成
```python
# 提供REST API接口
@app.route('/api/qa/check/<int:record_id>', methods=['POST'])
def check_single_qa(record_id):
    """检查单个问答记录"""
    pass

@app.route('/api/qa/batch-check', methods=['POST'])
def batch_check_qa():
    """批量检查问答记录"""
    pass
```

---

## 📚 相关文档

- [Excel数据导入数据库开发文档.md](./Excel数据导入数据库开发文档.md)
- [数据库配置开发文档.md](./数据库配置开发文档.md)
- [后端开发文档.md](./后端开发文档.md)

---

## 👥 维护信息

**开发人员**: AI Assistant  
**文档版本**: v1.0.0  
**最后更新**: 2025-10-25  
**联系方式**: 项目维护团队  

---

*本智能体基于LangChain框架和豆包大模型，为医美知识库提供自动化的质量保障服务。*
