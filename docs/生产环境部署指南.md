# 越南医疗整形项目 - 生产环境部署指南

## 📋 项目概述

越南医疗整形项目是一个基于 Astro + Tailwind CSS + Node.js 的现代化医疗整形平台，提供用户分享、知识问答、医院评价等功能。

## 🌐 访问信息

- **项目名称**: 越南医疗整形平台
- **官方域名**: `https://vietbeauty.top` (推荐) ⭐
- **备用域名**: `https://www.vietbeauty.top`
- **IP直接访问**: `http://47.237.79.9:5001`
- **后端API地址**: `http://47.237.79.9:5002`
- **前端端口**: 5001 (SSR服务)
- **后端端口**: 5002 (API服务)
- **SSL证书**: Let's Encrypt (自动续期)
- **DQA服务**: ✅ 已启动（每15分钟自动生成医院问答）
- **服务状态**: ✅ 运行中

## 🚀 快速部署

### 一键部署脚本（推荐）
```bash
cd /root/越南医疗整形项目
./deploy.sh
```

**部署脚本功能：**
- ✅ 自动部署后端服务
- ✅ 自动部署前端服务
- ✅ 安装依赖包
- ✅ 初始化数据库
- ✅ 配置开机自启动
- ✅ 重启服务
- ✅ 健康检查
- ✅ 显示访问信息

### 部署流程说明

部署脚本会按顺序执行以下步骤：

**第一部分：后端服务部署**
1. 停止后端服务
2. 安装后端依赖包 (`npm install`)
3. 创建必要目录 (data, logs)
4. 初始化数据库 (`npm run init-db`)
5. 配置 systemd 服务
6. 启动后端服务（DQA服务会自动启动）
7. 检查后端服务状态

**第二部分：前端服务部署**
8. 停止前端服务
9. 构建前端项目 (`npm run build`)
10. 配置开机自启动
11. 启动前端服务
12. 检查前端服务状态

**第三部分：服务健康检查**
13. 等待服务完全启动 (5秒)
14. 检查后端 API (`http://localhost:5002/health`)
15. 检查DQA服务 (`http://localhost:5002/api/dqa/status`)
16. 检查前端服务 (`http://localhost:5001`)

**第四部分：显示部署完成信息**
- 显示官方域名和访问地址
- 显示SSL证书状态
- 显示服务管理命令
- 显示开机自启动状态

### 部署脚本输出示例

运行 `./deploy.sh` 后，您会看到类似以下的输出：

```
🚀 开始部署越南医疗整形项目 (前端 + 后端)...

🔧 ========== 后端服务部署 ==========
📦 停止后端服务...
📦 安装后端依赖包...
📁 创建后端必要目录...
🗄️ 初始化数据库...
⚙️ 配置后端systemd服务...
🔄 启动后端服务...
✅ 检查后端服务状态...
● vietnam-medical-backend.service - 越南医疗整形项目后端服务
   Active: active (running)

🎨 ========== 前端服务部署 ==========
📦 停止前端服务...
🔨 构建前端项目...
⚙️ 配置前端开机自启动...
🔄 启动前端服务...
✅ 检查前端服务状态...
● vietnam-medical.service - 越南医疗整形项目前端SSR服务
   Active: active (running)

🏥 ========== 服务健康检查 ==========
⏳ 等待服务完全启动...
🔍 检查后端API...
✅ 后端API服务正常
🔍 检查前端服务...
✅ 前端服务正常

🎉 ========== 部署完成 ==========

🌐 官方网站: https://vietbeauty.top (推荐访问) ⭐
🌐 备用域名: https://www.vietbeauty.top
📱 IP访问地址: http://47.237.79.9:5001
📡 后端API地址: http://47.237.79.9:5002
📊 后端健康检查: http://47.237.79.9:5002/health
📚 后端API文档: http://47.237.79.9:5002/api/info
🤖 DQA服务状态: http://47.237.79.9:5002/api/dqa/status
🏥 医院问答页面: https://vietbeauty.top/knowledge?category=Tư%20vấn%20bệnh%20viện

🔒 SSL证书: Let's Encrypt (自动续期)
🚀 开机自启动: 已配置
⚡ Nginx反向代理: 已启用
🤖 DQA自动问答: 已启动（每15分钟生成1条医院问答）
```

### 部署检查清单

#### 部署前检查
- [ ] 确保服务器有足够的磁盘空间
- [ ] 确保Node.js和npm已安装
- [ ] 确保端口5001和5002未被占用
- [ ] 确保有systemd权限

#### 部署后检查
- [ ] 前端服务正常运行 (https://vietbeauty.top)
- [ ] 后端API服务正常运行 (http://47.237.79.9:5002)
- [ ] DQA服务正常运行 (http://47.237.79.9:5002/api/dqa/status)
- [ ] 数据库连接正常
- [ ] 所有页面可以正常访问
- [ ] API接口响应正常
- [ ] SSL证书有效
- [ ] DQA定时任务正常运行

## 🔧 服务管理

### 前端服务 (SSR)

**服务名称**: `vietnam-medical.service`  
**配置文件**: `/etc/systemd/system/vietnam-medical.service`  
**工作目录**: `/root/越南医疗整形项目`  
**运行方式**: Astro SSR (Node.js)  
**端口**: 5001

**服务配置**:
```ini
[Unit]
Description=越南医疗整形项目前端SSR服务
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/越南医疗整形项目
ExecStart=/usr/bin/node ./dist/server/entry.mjs
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
Environment=PORT=5001
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

**管理命令**:
```bash
# 启动前端服务
systemctl start vietnam-medical.service

# 停止前端服务
systemctl stop vietnam-medical.service

# 重启前端服务
systemctl restart vietnam-medical.service

# 查看服务状态
systemctl status vietnam-medical.service

# 查看实时日志
journalctl -u vietnam-medical.service -f

# 查看最近日志
journalctl -u vietnam-medical.service -n 50
```

### 后端服务 (API)

**服务名称**: `vietnam-medical-backend.service`  
**配置文件**: `/etc/systemd/system/vietnam-medical-backend.service`  
**工作目录**: `/root/越南医疗整形项目/backend`  
**运行方式**: Node.js Express  
**端口**: 5002

**服务配置**:
```ini
[Unit]
Description=越南医疗整形项目后端服务
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/越南医疗整形项目/backend
ExecStart=/usr/bin/node src/server.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
Environment=NODE_ENV=production
Environment=PORT=5002

[Install]
WantedBy=multi-user.target
```

**管理命令**:
```bash
# 启动后端服务
systemctl start vietnam-medical-backend.service

# 停止后端服务
systemctl stop vietnam-medical-backend.service

# 重启后端服务
systemctl restart vietnam-medical-backend.service

# 查看服务状态
systemctl status vietnam-medical-backend.service

# 查看实时日志
journalctl -u vietnam-medical-backend.service -f

# 查看最近日志
journalctl -u vietnam-medical-backend.service -n 50
```

### Nginx 服务 (反向代理)

**服务名称**: `nginx.service`  
**配置文件**: `/etc/nginx/conf.d/vietbeauty.conf`  
**运行方式**: Nginx HTTP Server  
**端口**: 80 (HTTP), 443 (HTTPS)

**管理命令**:
```bash
# 启动Nginx服务
systemctl start nginx.service

# 停止Nginx服务
systemctl stop nginx.service

# 重启Nginx服务
systemctl restart nginx.service

# 查看服务状态
systemctl status nginx.service

# 重载配置（不中断服务）
systemctl reload nginx.service

# 测试配置文件
nginx -t
```

### 批量服务管理

```bash
# 同时查看所有服务状态
systemctl status vietnam-medical.service vietnam-medical-backend.service nginx.service

# 同时重启所有服务
systemctl restart vietnam-medical.service vietnam-medical-backend.service nginx.service

# 查看所有服务的日志
journalctl -u vietnam-medical.service -u vietnam-medical-backend.service -f
```

## 📊 端口配置

### 端口占用详情

| 端口 | 协议 | 服务名称 | 进程 | 用途说明 |
|------|------|----------|------|----------|
| 80 | HTTP | Nginx (vietbeauty.top) | nginx | HTTP访问（自动重定向到HTTPS） |
| 443 | HTTPS | Nginx (vietbeauty.top) | nginx | HTTPS加密访问（推荐） |
| 5001 | HTTP | Vietnam Medical Frontend | node | 前端SSR服务（Astro） |
| 5002 | HTTP | Vietnam Medical Backend | node | 后端API服务（Express） |

### 端口选择说明

- **Nginx端口 80/443**: 对外提供HTTPS访问，反向代理到内部服务
- **前端端口 5001**: Astro SSR 服务，通过Nginx代理访问
- **后端端口 5002**: Express API 服务，通过Nginx代理访问
- **避免冲突**: 与 N8N 服务端口 (5678, 8080) 分开
- **绑定地址**: 
  - Nginx: `0.0.0.0` (公网访问)
  - 前后端: `127.0.0.1` 或 `0.0.0.0`

### 网络配置检查

```bash
# 检查所有端口监听状态
netstat -tulpn | grep -E ':(80|443|5001|5002)'

# 检查Nginx进程
ps aux | grep nginx

# 检查前端服务进程
ps aux | grep "entry.mjs"

# 检查后端服务进程
ps aux | grep "server.js"

# 测试HTTPS访问（推荐）
curl -I https://vietbeauty.top

# 测试HTTP访问（会重定向）
curl -I http://vietbeauty.top

# 测试前端直接访问
curl -I http://localhost:5001

# 测试后端API
curl http://localhost:5002/health

# 测试后端API信息
curl http://localhost:5002/api/info
```

## 🏗️ 项目结构

```
/root/越南医疗整形项目/
├── backend/                                  # 后端服务目录
│   ├── src/                                  # 后端源代码
│   │   ├── api/                              # API路由
│   │   │   ├── routes.js                    # 主路由配置
│   │   │   ├── userShareRoutes.js           # 用户分享API
│   │   │   ├── knowledgeRoutes.js           # 知识问答API
│   │   │   ├── hospitalRoutes.js            # 医院API
│   │   │   └── webhookRoutes.js             # Webhook API
│   │   ├── dqa/                              # DQA医院自动问答系统
│   │   │   ├── dqaRoutes.js                 # DQA API路由
│   │   │   ├── dqaService.js                # DQA服务主控制器
│   │   │   ├── dqaScheduler.js              # 定时任务调度器（每15分钟）
│   │   │   ├── dqaGenerator.js              # 问答内容生成器（6种类型）
│   │   │   ├── hospitalDataExtractor.js     # 医院数据提取器
│   │   │   ├── chainHospitalEnhancer.js     # 连锁医院地址补充器
│   │   │   ├── README.md                    # DQA技术文档
│   │   │   ├── DQA使用指南.md               # DQA使用指南
│   │   │   └── 部署完成报告.md              # 部署报告
│   │   ├── models/                           # 数据模型
│   │   │   ├── index.js                     # 模型配置
│   │   │   ├── UserShare.js                 # 用户分享模型
│   │   │   ├── Knowledge.js                 # 知识问答模型
│   │   │   └── Hospital.js                  # 医院模型
│   │   ├── scripts/                          # 脚本工具
│   │   │   └── init-database.js             # 数据库初始化
│   │   ├── utils/                            # 工具函数
│   │   │   └── logger.js                    # 日志工具
│   │   └── server.js                         # 服务入口
│   ├── data/                                 # 数据目录
│   │   ├── medical.db                       # SQLite数据库
│   │   └── backup/                          # 数据库备份目录
│   ├── logs/                                 # 日志目录
│   ├── package.json                          # 后端依赖配置
│   └── vietnam-medical-backend.service      # 后端服务配置
├── docs/                                     # 文档目录
│   ├── README.md                            # 文档索引
│   ├── 生产环境部署指南.md                  # 本文档 (完整部署指南)
│   ├── 技术架构图.md                        # 技术架构
│   ├── 前端开发文档.md                      # 前端开发
│   ├── 后端开发文档.md                      # 后端开发
│   ├── 数据库配置开发文档.md                # 数据库配置
│   ├── 用户分享功能配置完成.md              # 功能文档
│   ├── 知识问答功能配置完成.md              # 功能文档
│   ├── 医院详细信息更新说明.md              # 功能文档
│   └── 详情页面开发报告.md                  # 功能文档
├── src/                                      # 前端源代码目录
│   ├── components/                           # 组件目录
│   │   └── Navigation.astro                 # 导航组件
│   ├── layouts/                              # 布局文件
│   │   └── Layout.astro                     # 主布局
│   ├── pages/                                # 页面文件
│   │   ├── index.astro                      # 首页
│   │   ├── sharing.astro                    # 用户分享列表
│   │   ├── sharing/[id].astro               # 用户分享详情
│   │   ├── knowledge.astro                  # 知识问答列表
│   │   ├── knowledge/[id].astro             # 知识问答详情
│   │   ├── reviews.astro                    # 医院介绍列表
│   │   ├── reviews/[id].astro               # 医院详情
│   │   ├── services.astro                   # 服务内容
│   │   └── contact.astro                    # 联系我们
│   ├── styles/                               # 样式文件
│   │   └── global.css                       # 全局样式
│   └── utils/                                # 工具函数
│       └── api.js                           # API调用工具
├── dist/                                     # 前端构建输出目录
│   ├── client/                               # 客户端资源
│   └── server/                               # SSR服务文件
│       └── entry.mjs                        # SSR入口文件
├── public/                                   # 静态资源目录
├── deploy.sh                                 # 一键部署脚本 ⭐
├── package.json                              # 前端依赖配置
├── tailwind.config.mjs                       # Tailwind CSS 配置
├── astro.config.mjs                          # Astro 配置
└── README.md                                 # 项目说明

系统配置文件（/etc/目录）:
├── /etc/systemd/system/
│   ├── vietnam-medical.service              # 前端systemd服务配置
│   └── vietnam-medical-backend.service      # 后端systemd服务配置
├── /etc/nginx/conf.d/
│   └── vietbeauty.conf                      # Nginx域名配置
└── /etc/letsencrypt/live/vietbeauty.top/    # SSL证书目录
    ├── fullchain.pem                         # 完整证书链
    ├── privkey.pem                           # 私钥
    ├── cert.pem                              # 证书
    └── chain.pem                             # 证书链
```

## 🎨 技术栈

### 前端技术栈
- **框架**: Astro v5.14.1 (SSR模式)
- **适配器**: @astrojs/node (standalone模式)
- **样式**: Tailwind CSS v3.4.18
- **语言**: TypeScript
- **构建工具**: Vite
- **主题**: Cursor 黑色主题

### 后端技术栈
- **运行环境**: Node.js
- **框架**: Express
- **数据库**: SQLite (Sequelize ORM)
- **日志**: Winston
- **验证**: Joi
- **语言**: JavaScript (ES Modules)

### 基础设施
- **Web服务器**: Nginx 1.20.1
- **反向代理**: Nginx (前端5001 + 后端5002)
- **SSL证书**: Let's Encrypt
- **操作系统**: Linux (CentOS/AliyunOS)
- **进程管理**: systemd

## 🗄️ 数据库配置

### SQLite 数据库
- **位置**: `/root/越南医疗整形项目/backend/data/medical.db`
- **ORM**: Sequelize
- **数据表**:
  - `user_shares` - 用户分享表
  - `knowledge` - 知识问答表
  - `hospitals` - 医院信息表
  - `services` - 服务内容表
  - `contacts` - 联系记录表

### 数据库管理

```bash
# 初始化数据库
cd /root/越南医疗整形项目/backend
npm run init-db

# 查看数据库文件
ls -lh data/medical.db

# 备份数据库
cp data/medical.db data/medical_backup_$(date +%Y%m%d).db

# 恢复数据库
cp data/medical_backup_20241008.db data/medical.db
```

## 🔌 API 端点

### 健康检查
- `GET http://47.237.79.9:5002/health` - 服务健康检查
- `GET http://47.237.79.9:5002/api/info` - API信息

### DQA医院自动问答 (新增功能)
- `GET /api/dqa/status` - DQA服务状态
- `GET /api/dqa/stats` - DQA运行统计
- `GET /api/dqa/hospitals` - 获取医院清单（122家）
- `POST /api/dqa/generate` - 手动生成DQA问答
- `POST /api/dqa/scheduler/:action` - 控制定时任务（start/stop/restart）
- `GET /api/dqa/chain-hospitals/analyze` - 分析连锁医院
- `GET /api/dqa/chain-hospitals/suggestions` - 获取连锁医院补充建议
- `POST /api/dqa/chain-hospitals/enhance` - 自动补充连锁医院

### 用户分享
- `GET /api/user-shares` - 获取分享列表
- `GET /api/user-shares/:id` - 获取单个分享
- `POST /api/user-shares` - 创建分享
- `POST /api/user-shares/:id/like` - 点赞

### 知识问答
- `GET /api/knowledge` - 获取问答列表
- `GET /api/knowledge/:id` - 获取单个问答
- `POST /api/knowledge` - 创建问答
- `POST /api/knowledge/:id/like` - 点赞

### Webhook 集成
- `POST /api/webhooks/n8n` - N8N Webhook 接口
- `POST /api/webhooks/batch` - 批量处理接口
- `GET /api/webhooks/sync-status` - 同步状态

## 🔒 安全配置

### 访问控制
- **前端访问**: 端口 5001 对公网开放
- **后端访问**: 端口 5002 对公网开放
- **防火墙**: 建议配置防火墙规则
- **SSL**: 当前为 HTTP，建议后续配置 HTTPS

### 安全建议

1. **配置防火墙规则**
```bash
# 允许特定端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=5001/tcp
firewall-cmd --permanent --add-port=5002/tcp
firewall-cmd --reload
```

2. **Nginx 反向代理配置** (已配置)

Nginx配置文件位置：`/etc/nginx/conf.d/vietbeauty.conf`

```nginx
server {
    server_name vietbeauty.top www.vietbeauty.top;

    # 反向代理到前端服务
    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API代理到后端服务
    location /api {
        proxy_pass http://127.0.0.1:5002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/vietbeauty.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vietbeauty.top/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

server {
    if ($host = www.vietbeauty.top) {
        return 301 https://$host$request_uri;
    }

    if ($host = vietbeauty.top) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    server_name vietbeauty.top www.vietbeauty.top;
    return 404;
}
```

## 🌐 域名与SSL配置

### 域名信息
- **主域名**: vietbeauty.top
- **www域名**: www.vietbeauty.top
- **DNS解析**: 已配置指向 47.237.79.9
- **访问地址**: https://vietbeauty.top

### SSL证书配置

#### 证书信息
- **证书颁发机构**: Let's Encrypt
- **证书类型**: RSA 2048位
- **覆盖域名**: vietbeauty.top, www.vietbeauty.top
- **签发日期**: 2025年10月10日
- **到期日期**: 2026年1月8日
- **自动续期**: ✅ 已配置

#### 证书文件位置
```
证书路径：
├── 完整证书链: /etc/letsencrypt/live/vietbeauty.top/fullchain.pem
├── 私钥: /etc/letsencrypt/live/vietbeauty.top/privkey.pem
├── 证书: /etc/letsencrypt/live/vietbeauty.top/cert.pem
└── 证书链: /etc/letsencrypt/live/vietbeauty.top/chain.pem

Nginx配置：
└── /etc/nginx/conf.d/vietbeauty.conf

日志文件：
├── /var/log/nginx/vietbeauty_access.log
└── /var/log/nginx/vietbeauty_error.log
```

#### SSL证书管理命令

**查看证书信息**:
```bash
# 查看所有证书
certbot certificates

# 查看证书详情
openssl s_client -connect vietbeauty.top:443 -servername vietbeauty.top 2>/dev/null | openssl x509 -noout -dates -subject
```

**手动续期证书**:
```bash
# 测试续期（不实际执行）
certbot renew --dry-run

# 手动续期
certbot renew

# 强制续期
certbot renew --force-renewal
```

**自动续期配置**:
- ✅ 已配置自动续期定时任务: `certbot-renew.timer`
- 📅 每天自动检查证书是否需要续期
- 🔄 证书到期前30天自动续期

**查看自动续期状态**:
```bash
# 查看定时任务状态
systemctl list-timers | grep certbot

# 查看续期日志
journalctl -u certbot-renew.service -n 50
```

### DNS配置指南

如需配置新域名，请按以下步骤操作：

#### 1. 在域名注册商配置DNS解析

添加以下DNS记录：

**A记录配置**:
```
记录类型: A
主机记录: @
记录值: 47.237.79.9
TTL: 600
```

**www子域名配置**:
```
记录类型: A
主机记录: www
记录值: 47.237.79.9
TTL: 600
```

#### 2. 等待DNS生效

- 通常需要 10分钟 - 2小时
- 最长可能需要 24-48小时

#### 3. 验证DNS解析

```bash
# 检查DNS解析
nslookup vietbeauty.top
ping vietbeauty.top
```

#### 4. 配置Nginx和SSL证书

```bash
# 1. 创建Nginx配置
vim /etc/nginx/conf.d/yourdomain.conf

# 2. 测试配置
nginx -t

# 3. 重启Nginx
systemctl restart nginx

# 4. 申请SSL证书
certbot --nginx -d yourdomain.com -d www.yourdomain.com --non-interactive --agree-tos --email admin@yourdomain.com --redirect
```

## 📈 性能优化

### 当前配置
- **前端**: Astro SSR 服务器端渲染
- **后端**: Express + SQLite
- **反向代理**: Nginx (已配置)
- **SSL/TLS**: Let's Encrypt (已配置)
- **压缩**: Gzip (已启用)
- **缓存策略**: 浏览器默认缓存
- **数据库**: SQLite 文件数据库

### 已实现的优化
1. ✅ Nginx 反向代理
2. ✅ Gzip 压缩
3. ✅ HTTPS 加密传输
4. ✅ HTTP自动重定向到HTTPS
5. ✅ SSL证书自动续期

### 进一步优化建议
1. 配置静态资源缓存
2. 使用 CDN 加速
3. 定期备份数据库
4. 监控服务性能
5. 配置日志轮转

## 🛠️ 故障排除

### 常见问题

#### 1. 部署脚本执行失败
```bash
# 检查脚本权限
chmod +x deploy.sh

# 手动执行并查看详细输出
bash -x deploy.sh
```

#### 2. 端口被占用
```bash
# 查找占用端口的进程
netstat -tulpn | grep :5001
netstat -tulpn | grep :5002
netstat -tulpn | grep :80
netstat -tulpn | grep :443

# 杀死占用进程
kill -9 进程ID
```

#### 3. 前端服务启动失败
```bash
# 查看详细错误日志
journalctl -u vietnam-medical.service -n 50

# 检查构建文件是否存在
ls -la /root/越南医疗整形项目/dist/server/entry.mjs

# 重新构建
cd /root/越南医疗整形项目
npm run build
```

#### 4. 后端服务启动失败
```bash
# 查看详细错误日志
journalctl -u vietnam-medical-backend.service -n 50

# 检查数据库文件
ls -la /root/越南医疗整形项目/backend/data/

# 重新初始化数据库
cd /root/越南医疗整形项目/backend
npm run init-db
```

#### 5. 数据库错误
```bash
# 查看数据库文件权限
ls -la /root/越南医疗整形项目/backend/data/medical.db

# 确保权限正确
chown -R root:root /root/越南医疗整形项目/backend/data/

# 重新初始化（会重置数据）
cd /root/越南医疗整形项目/backend
rm data/medical.db
npm run init-db
```

#### 6. 依赖包问题
```bash
# 清理前端依赖
cd /root/越南医疗整形项目
rm -rf node_modules package-lock.json
npm install

# 清理后端依赖
cd /root/越南医疗整形项目/backend
rm -rf node_modules package-lock.json
npm install
```

#### 6. 文件权限问题
```bash
# 确保所有文件权限正确
chown -R root:root /root/越南医疗整形项目/
chmod +x /root/越南医疗整形项目/deploy.sh
```

#### 7. Nginx配置问题
```bash
# 测试Nginx配置
nginx -t

# 查看Nginx错误日志
tail -f /var/log/nginx/error.log

# 重启Nginx
systemctl restart nginx

# 查看Nginx状态
systemctl status nginx
```

#### 8. SSL证书问题
```bash
# 查看证书状态
certbot certificates

# 测试证书续期
certbot renew --dry-run

# 手动续期证书
certbot renew

# 查看证书错误日志
tail -f /var/log/letsencrypt/letsencrypt.log
```

#### 9. 域名无法访问
```bash
# 检查DNS解析
nslookup vietbeauty.top
ping vietbeauty.top

# 检查防火墙
firewall-cmd --list-ports

# 检查Nginx监听
netstat -tlnp | grep :80
netstat -tlnp | grep :443

# 测试本地访问
curl -I http://localhost
curl -I https://localhost
```

#### 10. DQA服务问题
```bash
# 检查DQA服务状态
curl http://localhost:5002/api/dqa/status

# 检查DQA统计信息
curl http://localhost:5002/api/dqa/stats

# 手动启动定时任务
curl -X POST http://localhost:5002/api/dqa/scheduler/start

# 手动生成测试问答
curl -X POST http://localhost:5002/api/dqa/generate \
  -H "Content-Type: application/json" \
  -d '{"count": 1}'

# 查看医院问答数量
sqlite3 /root/越南医疗整形项目/backend/data/medical.db \
  "SELECT COUNT(*) FROM knowledge WHERE category='Tư vấn bệnh viện';"
```

## 🔄 更新部署

### 标准更新流程
```bash
# 1. 拉取最新代码（如果使用Git）
cd /root/越南医疗整形项目
# git pull

# 2. 运行部署脚本
./deploy.sh

# 3. 验证服务状态
systemctl status vietnam-medical.service vietnam-medical-backend.service
```

### 仅更新前端
```bash
cd /root/越南医疗整形项目
systemctl stop vietnam-medical.service
npm run build
systemctl start vietnam-medical.service
```

### 仅更新后端
```bash
cd /root/越南医疗整形项目/backend
systemctl stop vietnam-medical-backend.service
npm install
systemctl start vietnam-medical-backend.service
```

## 📊 监控和维护

### 服务监控
```bash
# 查看服务运行时间
systemctl show -p ActiveEnterTimestamp vietnam-medical.service
systemctl show -p ActiveEnterTimestamp vietnam-medical-backend.service

# 查看服务资源占用
systemctl status vietnam-medical.service
systemctl status vietnam-medical-backend.service

# 查看系统资源
top -p $(pgrep -f "entry.mjs") -p $(pgrep -f "server.js")
```

### 日志管理

#### 系统日志
```bash
# 查看日志大小
journalctl --disk-usage

# 清理旧日志（保留最近7天）
journalctl --vacuum-time=7d

# 按时间查看日志
journalctl -u vietnam-medical.service --since "1 hour ago"
journalctl -u vietnam-medical-backend.service --since "1 hour ago"

# 查看今天的日志
journalctl -u vietnam-medical.service --since today

# 查看指定日期的日志
journalctl -u vietnam-medical.service --since "2025-10-01" --until "2025-10-10"
```

#### Nginx日志
```bash
# 查看访问日志
tail -f /var/log/nginx/vietbeauty_access.log

# 查看错误日志
tail -f /var/log/nginx/vietbeauty_error.log

# 分析访问日志
awk '{print $1}' /var/log/nginx/vietbeauty_access.log | sort | uniq -c | sort -rn | head -10
```

#### SSL证书日志
```bash
# 查看certbot日志
tail -f /var/log/letsencrypt/letsencrypt.log

# 查看续期服务日志
journalctl -u certbot-renew.service -n 50
```

### 数据库维护
```bash
# 定期备份数据库
cd /root/越南医疗整形项目/backend
mkdir -p data/backup
cp data/medical.db data/backup/medical_$(date +%Y%m%d_%H%M%S).db

# 查看数据库大小
du -h data/medical.db

# 优化数据库
sqlite3 data/medical.db "VACUUM;"
```

## 🚨 紧急情况处理

### 服务完全无法访问
```bash
# 1. 检查所有服务状态
systemctl status vietnam-medical.service vietnam-medical-backend.service nginx.service

# 2. 重启所有服务
systemctl restart vietnam-medical.service vietnam-medical-backend.service nginx.service

# 3. 如果还是不行，重新运行部署脚本
cd /root/越南医疗整形项目
./deploy.sh
```

### 数据库损坏
```bash
# 1. 停止后端服务
systemctl stop vietnam-medical-backend.service

# 2. 备份当前数据库
cp /root/越南医疗整形项目/backend/data/medical.db /root/越南医疗整形项目/backend/data/medical_backup_$(date +%Y%m%d).db

# 3. 重新初始化数据库
cd /root/越南医疗整形项目/backend
npm run init-db

# 4. 启动后端服务
systemctl start vietnam-medical-backend.service
```

### SSL证书过期
```bash
# 1. 手动续期证书
certbot renew --force-renewal

# 2. 重启Nginx
systemctl restart nginx

# 3. 验证证书
openssl s_client -connect vietbeauty.top:443 -servername vietbeauty.top 2>/dev/null | openssl x509 -noout -dates
```

### 域名解析问题
```bash
# 1. 检查DNS解析
nslookup vietbeauty.top
dig vietbeauty.top

# 2. 刷新DNS缓存（如果有）
systemctl restart nscd 2>/dev/null || true

# 3. 使用临时IP访问
# http://47.237.79.9:5001
```

## 📞 联系信息

- **项目维护**: 系统管理员
- **技术支持**: 开发团队
- **官方网站**: https://vietbeauty.top
- **文档更新**: 2025-10-10

## 📝 更新日志

### v1.4.0 (2025-10-11)
- ✅ 新增DQA医院自动问答系统
- ✅ 实现6种类型问答自动生成（资质、等级、服务、地址、联系、医生）
- ✅ 配置15分钟定时任务自动发布
- ✅ 集成122家医院数据
- ✅ 添加医院问答分类标签
- ✅ 优化Hero区域高度（缩小35%）
- ✅ 优化标签横向滚动显示
- ✅ 更新部署脚本支持DQA检查

### v1.3.0 (2025-10-10)
- ✅ 配置域名 vietbeauty.top
- ✅ 部署SSL证书 (Let's Encrypt)
- ✅ 配置Nginx反向代理
- ✅ 启用HTTPS和HTTP自动重定向
- ✅ 配置SSL自动续期
- ✅ 合并部署文档
- ✅ 完善故障排除指南

### v1.2.0 (2024-10-08)
- ✅ 更新为前后端分离架构
- ✅ 前端改用 Astro SSR 模式
- ✅ 后端使用 Express + SQLite
- ✅ 配置双服务 systemd 管理
- ✅ 添加健康检查功能
- ✅ 完善部署脚本

### v1.1.0 (2024-10-07)
- ✅ 添加知识问答功能
- ✅ 添加用户分享功能
- ✅ 集成 N8N Webhook
- ✅ 优化媒体块展示

### v1.0.0 (2024-10-06)
- ✅ 初始生产环境部署
- ✅ 配置 Cursor 黑色主题
- ✅ 设置 systemd 服务
- ✅ 创建部署脚本

## 📚 附录

### 常用命令速查

#### 服务管理
```bash
# 启动所有服务
systemctl start vietnam-medical.service vietnam-medical-backend.service nginx.service

# 停止所有服务
systemctl stop vietnam-medical.service vietnam-medical-backend.service nginx.service

# 重启所有服务
systemctl restart vietnam-medical.service vietnam-medical-backend.service nginx.service

# 查看所有服务状态
systemctl status vietnam-medical.service vietnam-medical-backend.service nginx.service

# 查看实时日志
journalctl -u vietnam-medical.service -u vietnam-medical-backend.service -f
```

#### 快速部署
```bash
# 一键部署
cd /root/越南医疗整形项目 && ./deploy.sh

# 仅更新前端
systemctl stop vietnam-medical.service && cd /root/越南医疗整形项目 && npm run build && systemctl start vietnam-medical.service

# 仅更新后端
systemctl stop vietnam-medical-backend.service && cd /root/越南医疗整形项目/backend && npm install && systemctl start vietnam-medical-backend.service
```

#### SSL证书管理
```bash
# 查看证书状态
certbot certificates

# 测试续期
certbot renew --dry-run

# 手动续期
certbot renew

# 查看自动续期定时任务
systemctl list-timers | grep certbot
```

#### 访问验证
```bash
# 测试前端服务
curl -I https://vietbeauty.top

# 测试后端API
curl http://47.237.79.9:5002/health

# 测试SSL证书
openssl s_client -connect vietbeauty.top:443 -servername vietbeauty.top 2>/dev/null | openssl x509 -noout -dates

# 检查DNS解析
nslookup vietbeauty.top
```

### 技术支持

如果遇到无法解决的问题，请提供以下信息：
1. 错误日志输出 (`journalctl -u vietnam-medical.service -n 100`)
2. 服务状态信息 (`systemctl status vietnam-medical.service`)
3. 系统环境信息 (`uname -a`, `node --version`)
4. 具体操作步骤和错误截图

---

**文档版本**: v1.4.0  
**最后更新**: 2025-10-11  
**适用版本**: 越南医疗整形项目 v1.4.0  
**官方网站**: https://vietbeauty.top

**注意**: 本文档包含完整的部署、配置和维护指南，定期更新。

**新增功能**: DQA医院自动问答系统已集成
- 技术文档：`/root/越南医疗整形项目/backend/src/dqa/README.md`
- 使用指南：`/root/越南医疗整形项目/docs/DQA使用指南.md`
