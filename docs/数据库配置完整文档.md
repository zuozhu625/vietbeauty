# 越南医疗整形项目 - 数据库配置完整文档 v3.0

## 📋 目录

- [项目概览](#项目概览)
- [数据库分离说明](#数据库分离说明)
- [系统架构图](#系统架构图)
- [数据库详细说明](#数据库详细说明)
- [数据生成方式](#数据生成方式)
- [API接口](#api接口)
- [维护操作](#维护操作)
- [常见问题](#常见问题)

---

## 📊 项目概览

### 基本信息

| 项目 | 信息 |
|------|------|
| **项目名称** | 越南医疗整形项目 |
| **前端地址** | http://47.237.79.9:5001 |
| **后端地址** | http://47.237.79.9:5002 |
| **数据库类型** | SQLite3 |
| **前端数据库** | database.sqlite（越南语网站数据） |
| **智能体数据库** | medical.db（中文训练数据，独立） |
| **前端框架** | Astro (SSR) |
| **后端框架** | Node.js + Express |
| **样式框架** | Tailwind CSS |

### ⚠️ 重要提示

**本项目有两个完全独立的数据库，用途不同，请勿混淆！**

| 数据库 | 文件路径 | 用途 | 语言 | 状态 |
|--------|----------|------|------|------|
| **database.sqlite** | `/backend/data/database.sqlite` | 前端网站展示 | 越南语 | ✅ 在线 |
| **medical.db** | `/backend/data/medical.db` | 智能体训练 | 中文 | ✅ 内部 |

### 数据统计（最新）

| 模块 | database.sqlite | medical.db |
|------|-----------------|------------|
| **医院** | 122家 | 122家（备份） |
| **用户分享** | 367条 | 367条（备份） |
| **知识问答** | 由DQA自动生成 | 1,829条中文数据 |
| **服务/联系** | 3条 | - |

---

## 🔀 数据库分离说明

### 分离目的

为避免数据混淆，确保：
1. 前端只展示越南语内容
2. 智能体只处理中文数据
3. 两者互不干扰，独立运作

### 分离日期

- **操作时间**: 2025-10-26
- **操作原因**: 中文智能体数据误导入，覆盖了越南语问答数据
- **分离方案**: 创建独立的前端数据库，保留智能体数据库

---

## 🏗️ 系统架构图

### 完整数据流向

```
┌──────────────────────────────────────────────────────────┐
│                    用户访问前端                           │
│              http://47.237.79.9:5001                     │
└──────────────────────────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────┐
│                前端服务 (Astro SSR)                       │
│                    Port: 5001                             │
│  • /reviews (医院) • /knowledge (问答) • /sharing (分享) │
└──────────────────────────────────────────────────────────┘
                          ↓ API调用
┌──────────────────────────────────────────────────────────┐
│             后端服务 (Node.js + Express)                  │
│                    Port: 5002                             │
│  • GET /api/hospitals  • GET /api/knowledge               │
│  • GET /api/user-shares                                   │
│  • POST /api/user-shares/n8n (N8N接入)                   │
└──────────────────────────────────────────────────────────┘
                          ↓
        ┌─────────────────────────────────────┐
        │                                     │
        ↓                                     ↓
┌──────────────────┐              ┌──────────────────┐
│ database.sqlite  │              │   medical.db     │
│  (前端网站)      │              │  (智能体训练)    │
│                  │              │                  │
│ • hospitals      │              │ • knowledge      │
│ • user_shares    │              │   (中文)         │
│ • knowledge      │◄─────────────┤ • knowledge_     │
│   (越南语)       │  DQA自动生成  │   history        │
│ • services       │              │                  │
│ • contacts       │              │                  │
└──────────────────┘              └──────────────────┘
        ↑                                     ↑
        │                                     │
   用户分享                              智能体处理
   (N8N输入)                            (Python脚本)
```

### 数据生成流程

**医院数据**:
```
手工创建脚本 → database.sqlite → 前端展示
```

**用户分享**:
```
N8N接口 → database.sqlite → 前端展示
```

**知识问答**:
```
┌─ DQA自动生成 → database.sqlite → 前端展示 (越南语)
│
└─ Excel导入 → medical.db → 智能体训练 (中文)
```

---

## 💾 数据库详细说明

### 1️⃣ database.sqlite - 前端越南语网站数据库

#### 基本信息

| 属性 | 值 |
|------|-----|
| **文件路径** | `/root/越南医疗整形项目/backend/data/database.sqlite` |
| **用途** | 前端网站展示（越南语） |
| **访问** | 通过后端API (port 5002) |
| **前端地址** | http://47.237.79.9:5001 |

#### 数据内容

| 表名 | 数据量 | 说明 | 状态 |
|------|--------|------|------|
| `hospitals` | 122条 | 越南医院信息 | ✅ 完整 |
| `user_shares` | 367条 | 用户分享（越南语） | ✅ 完整 |
| `knowledge` | 动态增长 | 知识问答（DQA自动生成） | ✅ 自动化 |
| `services` | 2条 | 服务项目 | ✅ 有数据 |
| `contacts` | 1条 | 联系信息 | ✅ 有数据 |

#### 后端配置

```javascript
// backend/src/models/index.js
const sequelize = new Sequelize({
  dialect: 'sqlite',
  storage: path.join(__dirname, '../../data/database.sqlite'),
  // ...
});
```

#### 数据流向

```
N8N/DQA → database.sqlite → 后端API → 前端展示
```

#### API验证

```bash
# 验证医院数据
curl http://localhost:5002/api/hospitals
# 返回: 122家医院

# 验证用户分享
curl http://localhost:5002/api/user-shares
# 返回: 367条分享

# 验证知识问答
curl http://localhost:5002/api/knowledge
# 返回: 0条（待DQA生成）
```

---

### 2️⃣ medical.db - 后端中文智能体数据库

#### 基本信息

| 属性 | 值 |
|------|-----|
| **文件路径** | `/root/越南医疗整形项目/backend/data/medical.db` |
| **用途** | 智能体训练和内容生成（内部使用） |
| **访问** | 仅供智能体脚本使用 |
| **语言** | 中文 |

#### 数据内容

| 表名 | 数据量 | 说明 |
|------|--------|------|
| `knowledge` | 1,829条 | 中文医美问答 |
| `knowledge_history` | 历史记录 | 智能体修改记录 |
| `hospitals` | 122条 | 医院备份 |
| `user_shares` | 367条 | 分享备份 |

#### 中文数据分类

| 分类 | 数量 |
|------|------|
| 丰胸 | 381条 |
| 五官 | 500条 |
| 产修 | 201条 |
| 吸脂 | 298条 |
| 牙矫 | 449条 |

#### 智能体脚本配置

```python
# scripts/qa_quality_checker.py
db_path = "/root/越南医疗整形项目/backend/data/medical.db"

# scripts/qa_generator_agent.py
db_path = "/root/越南医疗整形项目/backend/data/medical.db"
```

#### 数据流向

```
Excel导入 → medical.db → 智能体处理 → medical.db
```

---

## 🤖 数据生成方式

### 1. 医院数据 (hospitals)

**数据来源**: 手工创建  
**数据库**: `database.sqlite`  
**数量**: 122家  
**状态**: ✅ 完成

**生成方式**:
```javascript
// 通过脚本批量添加
node backend/src/scripts/add-hospitals.js
```

**特点**:
- 一次性导入完成
- 数据稳定，不常更新
- 包含完整医院信息（服务、设施、认证等）

---

### 2. 用户分享 (user_shares)

**数据来源**: N8N接口  
**数据库**: `database.sqlite`  
**数量**: 367条（持续增长）  
**状态**: ✅ 运行中

**生成方式**:
```bash
# 通过N8N专用接口提交
POST http://47.237.79.9:5002/api/user-shares/n8n
{
  "title": "分享标题",
  "content": "分享内容"
}
```

**特点**:
- N8N工作流自动提交
- 智能识别手术类型
- 自动填充作者信息

---

### 3. 知识问答 (knowledge) - ⭐ 重点

#### 3.1 前端展示数据 (database.sqlite)

**数据来源**: DQA自动生成  
**语言**: 越南语  
**数量**: 动态增长  
**状态**: ✅ 自动化运行

**DQA系统说明**:

| 属性 | 值 |
|------|-----|
| **全称** | Dynamic Q&A (动态问答系统) |
| **功能** | 自动生成越南语医院问答 |
| **数据源** | 122家医院数据 |
| **生成频率** | 每15分钟1条 |
| **每日产量** | 96条问答 |
| **每月产量** | ~2,880条问答 |

**问答类型**:
1. 医院资质问答
2. 医院等级问答
3. 医院服务问答
4. 医院地址问答
5. 医院联系方式问答
6. 医生团队问答

**生成示例**:
```json
{
  "question": "Bệnh viện FV Hospital có giấy phép hợp pháp không?",
  "answer": "Có, bệnh viện FV Hospital có đầy đủ giấy phép hoạt động...",
  "category": "Tư vấn bệnh viện",
  "source": "dqa"
}
```

**特点**:
- ✅ 完全自动化，无需人工干预
- ✅ 基于真实医院数据生成
- ✅ 拟人化表达（v1.5.0新增）
- ✅ 覆盖用户常见咨询场景

**监控**:
```bash
# 查看DQA服务状态
curl http://localhost:5002/api/dqa/status

# 查看生成统计
curl http://localhost:5002/api/dqa/stats
```

#### 3.2 智能体训练数据 (medical.db)

**数据来源**: Excel导入  
**语言**: 中文  
**数量**: 1,829条  
**状态**: ✅ 完成（仅供内部使用）

**用途**:
- 智能体质量检查训练
- 拟人化问答生成训练
- 不对外展示

**分类**:
- 丰胸: 381条
- 五官: 500条
- 产修: 201条
- 吸脂: 298条
- 牙矫: 449条

---

### 数据生成总结

| 模块 | 来源 | 方式 | 频率 | 语言 |
|------|------|------|------|------|
| 医院 | 手工 | 脚本导入 | 一次性 | 越南语 |
| 用户分享 | N8N | API接口 | 实时 | 越南语 |
| 知识问答（前端） | DQA | 自动生成 | 每15分钟 | 越南语 |
| 知识问答（智能体） | Excel | 脚本导入 | 一次性 | 中文 |

---

## 🚨 重要警告

### ❌ 禁止操作

1. **不要混淆数据库**
   - 前端永远使用 `database.sqlite`
   - 智能体永远使用 `medical.db`

2. **不要交叉导入**
   - ❌ 不要将 `medical.db` 的中文数据导入 `database.sqlite`
   - ❌ 不要将 `database.sqlite` 的数据导入 `medical.db`

3. **不要在前端展示中文数据**
   - 前端只展示越南语内容

4. **不要用智能体处理前端数据**
   - 智能体只处理 `medical.db` 的中文数据

---

## 📊 当前数据统计

### 前端网站 (database.sqlite)
- ✅ 医院: 122家（稳定）
- ✅ 用户分享: 367条（N8N持续增长）
- ✅ 知识问答: 由DQA自动生成（每15分钟1条）
- ✅ 服务/联系: 3条

### 智能体训练 (medical.db)
- ✅ 中文问答: 1,829条（训练用）
  - 丰胸: 381条
  - 五官: 500条
  - 产修: 201条
  - 吸脂: 298条
  - 牙矫: 449条
- ✅ 修改历史: 完整记录

---

## ❓ 常见问题

### Q1: 知识问答数据从哪来？
**A**: 知识问答由DQA系统自动生成，每15分钟生成1条越南语医院问答，基于122家医院的真实数据，**不再需要从N8N手动提交**。

### Q2: 如何查看DQA生成进度？
**A**: 访问 `http://localhost:5002/api/dqa/stats` 查看统计，或查看数据库：
```bash
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge WHERE source='dqa';"
```

### Q3: 用户分享数据如何添加？
**A**: 通过N8N接口提交：
```bash
curl -X POST http://47.237.79.9:5002/api/user-shares/n8n \
  -H "Content-Type: application/json" \
  -d '{"title":"标题","content":"内容"}'
```

### Q4: 两个数据库有什么区别？
**A**: 
- `database.sqlite`: 前端越南语网站数据，用户可见
- `medical.db`: 后端中文智能体数据，仅供AI训练，用户不可见

### Q5: 如何备份数据？
**A**:
```bash
# 备份前端数据库
cp /root/越南医疗整形项目/backend/data/database.sqlite \
   /root/越南医疗整形项目/backend/data/database.sqlite.$(date +%Y%m%d).bak
```

---

**文档版本**: v3.0  
**最后更新**: 2025-10-26  
**维护人员**: 开发团队  
**重要更新**: 
- ✅ 数据库分离完成
- ✅ DQA自动生成问答（不再依赖N8N）
- ✅ 完整的系统架构说明  
**状态**: ✅ 生产环境运行中
