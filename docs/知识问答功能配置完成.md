# ✅ 知识问答功能 - 完整功能文档 v2.0

**版本**: v2.0 (双智能体整合版)  
**最后更新**: 2025-10-26 15:55  
**状态**: ✅ 生产环境运行中

---

## 📋 目录

1. [系统概览](#系统概览)
2. [双智能体架构](#双智能体架构)
3. [数据库配置](#数据库配置)
4. [API接口](#api接口)
5. [DQA系统详解](#dqa系统详解)
6. [翻译智能体详解](#翻译智能体详解)
7. [N8N集成](#n8n集成)
8. [快速参考](#快速参考)

---

## 系统概览

### 前端展示

| 项目 | 信息 |
|------|------|
| **列表页** | https://vietbeauty.top/knowledge |
| **详情页** | https://vietbeauty.top/knowledge/[id] |
| **医院问答** | https://vietbeauty.top/knowledge?category=Tư%20vấn%20bệnh%20viện |
| **展示形式** | 3列网格媒体块布局 |
| **渲染方式** | SSR 服务器端渲染 |
| **分类筛选** | 支持7个分类标签 |
| **自动刷新** | 实时显示数据库最新内容 |

### 核心数据库

| 数据库 | 路径 | 用途 | 语言 | 状态 |
|--------|------|------|------|------|
| **database.sqlite** | `/backend/data/database.sqlite` | 前端网站展示 | 越南语 | ✅ 在线 |
| **medical.db** | `/backend/data/medical.db` | 智能体训练 | 中文 | ✅ 内部 |

---

## 双智能体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│         用户访问前端 (https://vietbeauty.top)            │
│              /knowledge 问答页面                         │
└─────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────┐
        │ database.sqlite (前端数据)    │
        │ • 122家医院数据               │
        │ • 用户分享 (367条)            │
        │ • 知识问答 (两种来源)         │
        └───────────────────────────────┘
                   ↑           ↑
         ┌─────────┘           └──────────┐
         │                                 │
    ┌────┴─────┐                   ┌──────┴──────┐
    │ DQA系统   │                   │ 翻译智能体   │
    │ v1.5.0    │                   │ v3.0       │
    └────┬─────┘                   └──────┬──────┘
         │                                 │
    122家医院              1,829条中文问答
    (自动生成)            (均匀分布翻译)
         │                                 │
    ├─ 医院资质                      ├─ 丰胸 (381条)
    ├─ 医院等级                      ├─ 五官 (500条)
    ├─ 医院服务                      ├─ 产修 (201条)
    ├─ 医院地址                      ├─ 吸脂 (298条)
    ├─ 医院联系                      └─ 牙矫 (449条)
    └─ 医生团队
```

### 两大智能体对比

| 特性 | DQA系统 v1.5.0 | 翻译智能体 v3.0 |
|------|----------------|-----------------|
| **功能** | 医院问答自动生成 | 中文问答越南语翻译 |
| **数据源** | 122家医院信息 | 1,829条中文问答 |
| **生成模式** | 模板+随机组合 | 大模型翻译优化 |
| **运行频率** | 每15分钟1条 | 每15分钟1条 |
| **日产量** | 96条/天 | 96条/天 |
| **分类分布** | 医院咨询 | 5大类均匀分布 |
| **拟人化** | 15开场+10结尾 | LLM自然生成 |
| **循环周期** | 持续循环 | ~19天/轮 |
| **质量检查** | 模板保证 | 中文检测+清理 |

---

## 数据库配置

### database.sqlite (前端数据库)

**路径**: `/root/越南医疗整形项目/backend/data/database.sqlite`

**包含的表**:

| 表名 | 数据量 | 说明 | 状态 |
|------|--------|------|------|
| `hospitals` | 122条 | 越南医院信息 | ✅ 稳定 |
| `user_shares` | 367条 | 用户分享（越南语） | ✅ N8N持续增长 |
| `knowledge` | 动态增长 | 知识问答（DQA+翻译） | ✅ 自动化 |
| `services` | 2条 | 服务项目 | ✅ 有数据 |
| `contacts` | 1条 | 联系信息 | ✅ 有数据 |

**知识问答来源**:

| 来源 | 类型 | 数量 | 分类 | 标记 |
|------|------|------|------|------|
| **DQA系统** | 医院问答 | 动态增长 | Tư vấn bệnh viện | source='dqa' |
| **翻译智能体** | 手术咨询 | 动态增长 | 5大分类 | source='ai_translation' |

### medical.db (智能体数据库)

**路径**: `/root/越南医疗整形项目/backend/data/medical.db`

**中文问答分类统计**:

| 分类 | 数量 | 说明 |
|------|------|------|
| 丰胸 (Thẩm mỹ ngực) | 381条 | 隆胸相关 |
| 五官 (Thẩm mỹ khuôn mặt) | 500条 | 面部整形 |
| 产修 (Phục hồi sau sinh) | 201条 | 产后修复 |
| 吸脂 (Hút mỡ tạo dáng) | 298条 | 吸脂塑形 |
| 牙矫 (Niềng răng) | 449条 | 牙齿矫正 |
| **总计** | **1,829条** | **完整数据集** |

---

## API接口

### 知识问答API

```bash
# 获取问答列表 (支持分页、分类筛选、搜索)
GET /api/knowledge

# 获取单个问答详情 (自动+1浏览数)
GET /api/knowledge/:id

# 创建问答 (完整字段)
POST /api/knowledge

# 点赞操作 (自动+1点赞数)
POST /api/knowledge/:id/like

# N8N专用接口 (简化版)
POST /api/knowledge/n8n
```

### DQA相关API

```bash
# 查看DQA服务状态
GET /api/dqa/status

# 查看DQA统计信息
GET /api/dqa/stats

# 获取医院清单 (122家)
GET /api/dqa/hospitals

# 手动生成DQA问答
POST /api/dqa/generate

# 控制定时任务 (start/stop/restart)
POST /api/dqa/scheduler/:action
```

### 数据库查询命令

```bash
# 查看DQA生成的问答数
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge WHERE source='dqa';"

# 查看翻译智能体生成的问答数
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge WHERE source='ai_translation';"

# 按分类统计 (DQA)
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT category, COUNT(*) FROM knowledge WHERE source='dqa' GROUP BY category;"

# 按分类统计 (翻译智能体)
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT category, COUNT(*) FROM knowledge WHERE source='ai_translation' GROUP BY category;"

# 总问答数
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge;"
```

---

## DQA系统详解

### 基本信息

**名称**: Dynamic Q&A Generator (v1.5.0 拟人化优化版)  
**文件**: `/root/越南医疗整形项目/backend/src/dqa/dqaGenerator.js`  
**语言**: JavaScript (Node.js)  
**启动**: 随后端自动启动，每15分钟运行一次

### 核心特性

#### 1. 问答类型 (6种)

1. **医院资质问答** - 医院合法性、证件齐全性
2. **医院等级问答** - 医院等级、认证情况
3. **医院服务问答** - 提供的医美服务项目
4. **医院地址问答** - 具体位置、分院信息
5. **医院联系方式** - 咨询电话、预约、工作时间
6. **医生团队问答** - 医生资质、经验介绍

#### 2. 拟人化优化 (v1.5.0)

**15种个性化开场白**:
```vietnamese
- "Chào bạn!"
- "Bạn ơi,"
- "Mình có thể giúp bạn..."
- "Xin chào!"
- "Hi bạn!"
... (11 more variations)
```

**10种温馨结尾语**:
```vietnamese
- "Hy vọng thông tin này hữu ích cho bạn nhé!"
- "Chúc bạn có những lựa chọn tốt nhất!"
- "Nếu còn thắc mắc gì, đừng ngần ngại liên hệ nhé!"
... (7 more variations)
```

**14种自然过渡词**:
```vietnamese
- "À mà"
- "Nói thêm là"
- "Bạn biết không"
- "Thực ra thì"
... (10 more variations)
```

#### 3. 生成配置

| 配置项 | 值 |
|--------|-----|
| 数据源 | 122家医院数据 |
| 生成频率 | 每15分钟1条 |
| 每日产量 | 96条/天 |
| 每月产量 | ~2,880条/月 |
| 分类标签 | Tư vấn bệnh viện (医院咨询) |
| 源标记 | source='dqa' |

#### 4. 监控DQA

```bash
# 查看DQA状态
curl http://localhost:5002/api/dqa/status

# 查看统计信息
curl http://localhost:5002/api/dqa/stats

# 查看生成的医院问答数
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge WHERE source='dqa';"

# 手动生成一条测试
curl -X POST http://localhost:5002/api/dqa/generate
```

---

## 翻译智能体详解

### 基本信息

**名称**: 越南语问答翻译智能体 (v3.0 均匀分布优化版)  
**文件**: `/root/越南医疗整形项目/scripts/qa_translator_agent.py`  
**语言**: Python 3.7+  
**模型**: Doubao-Seed-1.6-flash (豆包Flash)  
**启动**: 后台定时运行或手动触发

### 核心特性

#### 1. 均匀分布算法

自动优先翻译已翻译最少的分类，确保5大分类均衡：

```
优先级: 已翻译数最少的分类 > 其次 > ...

例如:
  丰胸: 5条 ← 优先翻译
  五官: 8条
  产修: 10条
  吸脂: 12条
  牙矫: 15条
```

#### 2. 分类映射

| 中文分类 | 越南语分类 | 说明 |
|---------|----------|------|
| 丰胸 | Thẩm mỹ ngực | 胸部美容 |
| 五官 | Thẩm mỹ khuôn mặt | 面部美容 |
| 产修 | Phục hồi sau sinh | 产后恢复 |
| 吸脂 | Hút mỡ tạo dáng | 吸脂塑形 |
| 牙矫 | Niềng răng | 牙齿矫正 |

#### 3. 质量保证

- ✅ **100%纯越南语**: 自动检测并清理中文残留
- ✅ **5次重试机制**: API调用最多重试5次确保成功
- ✅ **中文检测**: 自动识别任何中文字符
- ✅ **自动清理**: 已知医学术语自动映射替换
- ✅ **JSON容错**: 处理LLM输出的各种格式问题

#### 4. 翻译配置

| 配置项 | 值 |
|--------|-----|
| 数据源 | medical.db (1,829条) |
| 生成频率 | 每15分钟1条 |
| 重试次数 | 最多5次 |
| 循环周期 | ~19天完成一轮 |
| 源标记 | source='ai_translation' |

#### 5. 启动翻译智能体

```bash
# 单条翻译测试
cd /root/越南医疗整形项目
bash -c 'unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY; \
python3 scripts/qa_translator_agent.py --once'

# 批量翻译100条
bash -c 'unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY; \
nohup python3 scripts/qa_translator_agent.py --batch 100 > logs/batch_100.log 2>&1 &'

# 查看翻译进度
python3 scripts/qa_translator_agent.py --stats

# 查看分类分布
sqlite3 backend/data/database.sqlite \
  "SELECT category, COUNT(*) FROM knowledge WHERE source='ai_translation' GROUP BY category;"
```

---

## N8N集成

### 方式1: 知识问答专用接口 (推荐)

**URL**: `http://47.237.79.9:5002/api/knowledge/n8n`

**最简数据格式** (仅需2个字段):
```json
{
  "question": "问题内容",
  "answer": "答案内容"
}
```

**完整字段示例**:
```json
{
  "question": "Phẫu thuật mũi có đau không?",
  "answer": "Không đau vì được gây tê hoặc gây mê.",
  "category": "Thẩm mỹ khuôn mặt",
  "doctor_name": "BS Nguyễn Văn A"
}
```

### 方式2: 通用Webhook接口

**URL**: `http://47.237.79.9:5002/api/webhooks/n8n`

**数据格式** (需要type字段):
```json
{
  "type": "knowledge",
  "data": {
    "question": "问题内容",
    "answer": "答案内容"
  }
}
```

### 测试命令

```bash
# 测试专用接口
curl -X POST http://localhost:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{"question":"测试问题","answer":"测试答案"}'

# 测试通用Webhook
curl -X POST http://localhost:5002/api/webhooks/n8n \
  -H "Content-Type: application/json" \
  -d '{"type":"knowledge","data":{"question":"测试","answer":"答案"}}'

# 验证数据
curl http://localhost:5002/api/knowledge?limit=5
```

---

## 快速参考

### 数据库模型

**必填字段**:
- `question` - 问题（最多500字符）
- `answer` - 答案（TEXT类型）

**可选字段** (有默认值):
- `category` - 默认 "Tư vấn chung"
- `doctor_name` - 默认 "Bác sĩ chuyên khoa"
- `source` - 标记来源 (dqa / ai_translation / manual / n8n)

**自动字段**:
- `like_count` - 点赞数（默认0）
- `view_count` - 浏览数（默认0）

### 监控命令

```bash
# 1. 查看所有服务状态
systemctl status vietnam-medical.service vietnam-medical-backend.service

# 2. 查看DQA运行情况
curl http://localhost:5002/api/dqa/stats

# 3. 查看翻译进度
python3 /root/越南医疗整形项目/scripts/qa_translator_agent.py --stats

# 4. 查看问答总数
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT source, COUNT(*) FROM knowledge GROUP BY source;"

# 5. 查看实时日志
journalctl -u vietnam-medical-backend.service -f
```

### 常见操作

```bash
# 启动DQA定时任务
curl -X POST http://localhost:5002/api/dqa/scheduler/start

# 手动生成一条DQA问答
curl -X POST http://localhost:5002/api/dqa/generate

# 启动翻译智能体 (单条)
python3 /root/越南医疗整形项目/scripts/qa_translator_agent.py --once

# 批量翻译 (100条后台运行)
cd /root/越南医疗整形项目 && \
bash -c 'unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY; \
nohup python3 scripts/qa_translator_agent.py --batch 100 > logs/batch.log 2>&1 &'

# 前端验证
curl -I https://vietbeauty.top/knowledge
```

---

## 🎉 完成状态

### 基础功能
- ✅ 前端页面改造完成
- ✅ 后端API配置完成
- ✅ N8N Webhook集成完成
- ✅ 数据库模型优化完成
- ✅ SSR渲染配置完成
- ✅ 测试脚本创建完成

### DQA系统 (v1.5.0)
- ✅ 医院数据提取完成（122家）
- ✅ 6种问答类型实现完成
- ✅ 定时任务配置完成（每15分钟）
- ✅ 拟人化表达集成完成
- ✅ 医院问答分类标签添加完成
- ✅ 前端页面优化完成

### 翻译智能体 (v3.0)
- ✅ 中文检测和自动清理完成
- ✅ 均匀分布算法实现完成
- ✅ 分类映射配置完成
- ✅ 重试机制集成完成
- ✅ JSON容错处理完成
- ✅ 进度追踪实现完成
- ✅ 批量翻译脚本完成
- ✅ 100%纯越南语保证完成

### 数据库分离
- ✅ database.sqlite (前端越南语)
- ✅ medical.db (智能体中文)
- ✅ 完全分离，互不干扰

---

**文档版本**: v2.0  
**最后更新**: 2025-10-26 15:55  
**维护人员**: 开发团队  
**状态**: ✅ 生产环境运行中

**核心系统**:
- 🤖 DQA医院自动问答系统 (v1.5.0)
- 🤖 越南语问答翻译智能体 (v3.0)
- 📊 双数据库分离架构
- ⏰ 每15分钟自动内容生成
- 🌐 前端实时SSR展示
