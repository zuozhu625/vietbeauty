# ✅ 知识问答功能 - 实际功能文档

## 📋 系统概览

### 1. 前端页面 ✅
- **列表页**: https://vietbeauty.top/knowledge
- **详情页**: https://vietbeauty.top/knowledge/[id]
- **医院问答**: https://vietbeauty.top/knowledge?category=Tư%20vấn%20bệnh%20viện (v1.4.0新增)
- **展示形式**: 3列网格媒体块布局
- **渲染方式**: SSR 服务器端渲染，实时从数据库读取
- **分类筛选**: 支持7个分类，横向滚动显示（v1.4.0优化）

### 2. 数据库模型 ✅
**必填字段**：
- `question` - 问题（最多500字符）
- `answer` - 答案（TEXT类型）

**可选字段（有默认值）**：
- `category` - 默认 "Tư vấn chung"
- `doctor_name` - 默认 "Bác sĩ chuyên khoa"
- `subcategory`, `doctor_title`, `doctor_avatar`, `hospital_name`, `tags`
- `difficulty_level` - 默认 "beginner"
- `status` - 默认 "published"
- `source` - 默认 "manual"

**自动字段**：
- `like_count` - 点赞数（默认0）
- `view_count` - 浏览数（默认0）
- `external_id` - 外部系统ID（用于防重复）

### 3. API 接口 ✅
- `GET /api/knowledge` - 获取列表（支持分页、分类筛选、搜索）
- `GET /api/knowledge/:id` - 获取详情（自动+1浏览数）
- `POST /api/knowledge` - 创建问答（完整字段）
- `POST /api/knowledge/:id/like` - 点赞（自动+1点赞数）
- `POST /api/knowledge/n8n` - N8N专用接口（简化）
- `POST /api/webhooks/n8n` - 通用Webhook（需type字段）
- `POST /api/webhooks/batch` - 批量处理

### 4. DQA自动问答系统 ✅ (v1.4.0新增)
- `GET /api/dqa/status` - DQA服务状态
- `GET /api/dqa/stats` - DQA运行统计
- `POST /api/dqa/generate` - 手动生成DQA问答
- `POST /api/dqa/scheduler/:action` - 控制定时任务
- **功能**: 基于122家医院数据自动生成问答
- **类型**: 6种（资质、等级、服务、地址、联系、医生）
- **频率**: 每15分钟自动生成1条
- **分类**: 统一标记为"Tư vấn bệnh viện"

---

## 🔌 N8N 集成方式（两种）

### 方式1：知识问答专用接口（推荐）

**URL**: `http://47.237.79.9:5002/api/knowledge/n8n`

**最简数据格式**（只需2个字段）：
```json
{
  "question": "问题内容",
  "answer": "答案内容"
}
```

**可选字段**：
```json
{
  "question": "问题内容",
  "answer": "答案内容",
  "category": "Phẫu thuật mũi",
  "doctor_name": "BS Nguyễn Văn A"
}
```

### 方式2：通用Webhook接口

**URL**: `http://47.237.79.9:5002/api/webhooks/n8n`

**数据格式**（需要type字段）：
```json
{
  "type": "knowledge",
  "data": {
    "question": "问题内容",
    "answer": "答案内容"
  }
}
```

## 🚀 使用示例

### 示例1: N8N专用接口（最简单）

```bash
curl -X POST http://47.237.79.9:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Phẫu thuật mũi có đau không?",
    "answer": "Không đau vì được gây tê hoặc gây mê."
  }'
```

### 示例2: 通用Webhook接口

```bash
curl -X POST http://47.237.79.9:5002/api/webhooks/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "type": "knowledge",
    "data": {
      "question": "Phẫu thuật mũi có đau không?",
      "answer": "Không đau vì được gây tê hoặc gây mê."
    }
  }'
```

### 示例3: 完整API调用

```bash
curl -X POST http://47.237.79.9:5002/api/knowledge \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Phẫu thuật mũi cần bao lâu?",
    "answer": "Thời gian phục hồi khoảng 1-2 tuần.",
    "category": "Phẫu thuật mũi",
    "doctor_name": "BS Nguyễn Văn A"
  }'
```

## 🧪 测试方法

### 测试1: 专用接口（推荐）
```bash
curl -X POST http://localhost:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{"question":"测试问题","answer":"测试答案"}'
```

### 测试2: 通用Webhook
```bash
curl -X POST http://localhost:5002/api/webhooks/n8n \
  -H "Content-Type: application/json" \
  -d '{"type":"knowledge","data":{"question":"测试","answer":"答案"}}'
```

### 测试3: 查看结果
```bash
# 查看列表
curl http://localhost:5002/api/knowledge

# 查看详情
curl http://localhost:5002/api/knowledge/1
```

## 📊 数据流程

```
N8N 发送数据
    ↓
POST /api/webhooks/n8n
    ↓
后端验证数据
    ↓
保存到 SQLite 数据库
    ↓
前端 SSR 读取数据
    ↓
用户访问页面看到新问答
```

## 🔍 访问地址

- **前端列表页**: http://47.237.79.9:5001/knowledge
- **前端详情页**: http://47.237.79.9:5001/knowledge/{id}
- **后端 API**: http://47.237.79.9:5002/api/knowledge
- **健康检查**: http://47.237.79.9:5002/health

## 📁 相关文件

### 前端文件
- `/root/越南医疗整形项目/src/pages/knowledge.astro` - 列表页
- `/root/越南医疗整形项目/src/pages/knowledge/[id].astro` - 详情页
- `/root/越南医疗整形项目/src/utils/api.js` - API 调用工具

### 后端文件
- `/root/越南医疗整形项目/backend/src/models/Knowledge.js` - 数据模型
- `/root/越南医疗整形项目/backend/src/api/knowledgeRoutes.js` - API 路由
- `/root/越南医疗整形项目/backend/src/api/webhookRoutes.js` - Webhook 处理
- `/root/越南医疗整形项目/backend/data/database.sqlite` - 数据库文件

### 文档文件
- `/root/越南医疗整形项目/backend/docs/N8N_知识问答集成指南.md` - 详细集成指南
- `/root/越南医疗整形项目/backend/test-knowledge-webhook.sh` - 测试脚本

## 🎯 核心特性

### 1. 简化数据提交
只需要提供 `question` 和 `answer` 两个字段即可，其他字段会自动填充默认值。

### 2. 实时更新
使用 SSR 服务器端渲染，每次页面加载都会从数据库读取最新数据，无需手动刷新或构建。

### 3. 防重复
通过 `external_id` 字段防止重复提交，相同 ID 的数据会更新而不是新建。

### 4. 完整分页
支持分页导航，每页显示 36 个问答，自动计算总页数。

### 5. 统一风格
与用户分享页面保持一致的媒体块展示风格，界面简洁美观。

### 6. 智能分类筛选 (v1.4.0)
- 支持7个分类标签，横向滚动显示
- 医院问答使用绿色主题，区别于其他蓝色标签
- URL参数筛选：`?category=Tư%20vấn%20bệnh%20viện`

### 7. DQA自动化 (v1.4.0)
- 每15分钟自动生成1条医院问答
- 基于122家医院真实数据
- 6种问答类型覆盖用户核心关注点
- 无需人工干预，自动发布到问答板块

## 🔒 默认值

| 字段 | 默认值 |
|------|--------|
| category | "Tư vấn chung" |
| doctor_name | "Bác sĩ chuyên khoa" |
| like_count | 0 |
| view_count | 0 |
| status | "published" |
| source | "n8n" |
| difficulty_level | "beginner" |

## ✨ 已测试功能

### 基础功能
- ✅ 最简数据提交（只有 question 和 answer）
- ✅ 完整字段提交
- ✅ 批量数据提交
- ✅ 数据库存储
- ✅ API 查询
- ✅ 前端 SSR 渲染
- ✅ 防重复机制
- ✅ 分页功能
- ✅ 默认值填充

### DQA扩展功能 (v1.4.0)
- ✅ DQA服务自动启动
- ✅ 定时任务正常运行（每15分钟）
- ✅ 医院数据提取（122家）
- ✅ 问答自动生成（6种类型）
- ✅ 医院问答分类标签（绿色主题）
- ✅ 横向滚动标签布局
- ✅ 连锁医院识别和建议

## 📞 技术支持

### 检查服务状态
```bash
# 后端服务
systemctl status vietnam-medical-backend.service

# 前端服务
systemctl status vietnam-medical.service
```

### 查看日志
```bash
# 后端日志
journalctl -u vietnam-medical-backend.service -f

# 前端日志
journalctl -u vietnam-medical.service -f
```

### 重启服务
```bash
# 重启后端
systemctl restart vietnam-medical-backend.service

# 重启前端
systemctl restart vietnam-medical.service
```

## 🎉 完成状态

### 基础功能
- ✅ 前端页面改造完成
- ✅ 后端 API 配置完成
- ✅ N8N Webhook 集成完成
- ✅ 数据库模型优化完成
- ✅ SSR 渲染配置完成
- ✅ 测试脚本创建完成
- ✅ 文档编写完成
- ✅ 部署上线完成

### DQA扩展功能 (v1.4.0)
- ✅ DQA系统开发完成
- ✅ 6种问答类型实现完成
- ✅ 定时任务配置完成
- ✅ 医院问答分类标签添加完成
- ✅ 前端页面优化完成
- ✅ 文档同步更新完成

---

**初始配置**: 2024-10-08  
**DQA升级**: 2025-10-11  
**当前版本**: v1.4.0  
**状态**: ✅ 生产环境运行中

**新增功能**: 
- 🤖 DQA医院自动问答系统
- 📊 122家医院数据智能化利用
- ⏰ 每15分钟自动内容生成
- 🏥 医院问答专属分类标签

