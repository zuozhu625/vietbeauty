# 越南医疗整形项目 - 项目架构开发文档

## 📋 文档概述

本文档详细说明越南医疗整形项目的完整技术架构，包括系统层次、技术选型、数据流向、部署架构等，帮助开发者快速理解项目的整体设计。

## 🌐 项目基本信息

| 项目 | 信息 |
|------|------|
| **项目名称** | 越南医疗整形平台 (Vietnam Medical Beauty Platform) |
| **官方域名** | https://vietbeauty.top |
| **服务器IP** | 47.237.79.9 |
| **项目版本** | v1.3.0 |
| **上线日期** | 2024年10月 |
| **最后更新** | 2025年10月10日 |

## 🏗️ 整体系统架构

### 完整架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                       用户访问层                                 │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │   桌面浏览器  │  │   移动浏览器  │  │   平板浏览器  │       │
│  │   (Desktop)   │  │   (Mobile)    │  │   (Tablet)    │       │
│  └───────────────┘  └───────────────┘  └───────────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              │
                    HTTPS (443) / HTTP (80)
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Web服务器层 (Nginx)                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     vietbeauty.top                        │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  🔒 SSL/TLS (Let's Encrypt)                        │  │  │
│  │  │  - 自动HTTPS重定向                                 │  │  │
│  │  │  - 证书自动续期                                    │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  ⚡ 反向代理                                        │  │  │
│  │  │  - 前端: / → 127.0.0.1:5001                       │  │  │
│  │  │  - 后端: /api → 127.0.0.1:5002                    │  │  │
│  │  │  - Gzip压缩                                        │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
┌──────────────────────────────┐  ┌──────────────────────────────┐
│      前端服务层 (Port 5001)   │  │      后端服务层 (Port 5002)   │
│  ┌────────────────────────┐  │  │  ┌────────────────────────┐  │
│  │   Astro SSR Server     │  │  │  │   Express REST API     │  │
│  │   (Node.js)            │  │  │  │   (Node.js)            │  │
│  │                        │  │  │  │                        │  │
│  │  ┌──────────────────┐  │  │  │  │  ┌──────────────────┐  │  │
│  │  │  页面渲染        │  │  │  │  │  │  路由处理        │  │  │
│  │  │  - index.astro   │  │  │  │  │  │  - userShare     │  │  │
│  │  │  - sharing.astro │  │  │  │  │  │  - knowledge     │  │  │
│  │  │  - knowledge     │  │  │  │  │  │  - hospital      │  │  │
│  │  │  - reviews.astro │  │  │  │  │  │  - webhook       │  │  │
│  │  │  - services      │  │  │  │  │  └──────────────────┘  │  │
│  │  │  - contact       │  │  │  │  │                        │  │
│  │  └──────────────────┘  │  │  │  │  ┌──────────────────┐  │  │
│  │                        │  │  │  │  │  业务逻辑        │  │  │
│  │  ┌──────────────────┐  │  │  │  │  │  - 数据验证      │  │  │
│  │  │  组件渲染        │  │  │  │  │  │  - 权限控制      │  │  │
│  │  │  - Navigation    │  │  │  │  │  │  - 日志记录      │  │  │
│  │  │  - Layout        │◄─┼──┼──┼──┼──►  - 错误处理      │  │  │
│  │  │  - MediaCard     │  │  │  │  │  └──────────────────┘  │  │
│  │  └──────────────────┘  │  │  │  │          │             │  │
│  │                        │  │  │  │          ▼             │  │
│  │  ┌──────────────────┐  │  │  │  │  ┌──────────────────┐  │  │
│  │  │  API调用         │  │  │  │  │  │  ORM (Sequelize) │  │  │
│  │  │  - fetch         │──┼──┼──┼──┼─►│  - Models        │  │  │
│  │  │  - utils/api.js  │  │  │  │  │  │  - Validation    │  │  │
│  │  └──────────────────┘  │  │  │  │  └──────────────────┘  │  │
│  └────────────────────────┘  │  │  └────────────────────────┘  │
│                              │  │              │                │
│  systemd:                    │  │  systemd:    │                │
│  vietnam-medical.service     │  │  vietnam-medical-backend     │
└──────────────────────────────┘  └──────────────────────────────┘
                                                  │
                                                  ▼
                              ┌──────────────────────────────────┐
                              │      数据持久层                   │
                              │  ┌────────────────────────────┐  │
                              │  │   SQLite Database          │  │
                              │  │   (medical.db)             │  │
                              │  │                            │  │
                              │  │  Tables:                   │  │
                              │  │  - user_shares (用户分享)  │  │
                              │  │  - knowledge (知识问答)    │  │
                              │  │  - hospitals (医院信息)    │  │
                              │  │  - services (服务内容)     │  │
                              │  │  - contacts (联系记录)     │  │
                              │  └────────────────────────────┘  │
                              │                                  │
                              │  备份: data/backup/              │
                              └──────────────────────────────────┘
```

## 📊 分层架构详解

### 1️⃣ 用户访问层

**功能**: 提供跨设备访问体验

**支持设备**:
- 🖥️ **桌面端**: Chrome, Firefox, Safari, Edge
- 📱 **移动端**: iOS Safari, Android Chrome
- 📟 **平板端**: iPad, Android平板

**访问方式**:
- 主域名: `https://vietbeauty.top`
- www域名: `https://www.vietbeauty.top`
- IP备用: `http://47.237.79.9:5001`

**响应式断点**:
```
- sm:  ≥ 640px  (小屏手机)
- md:  ≥ 768px  (平板竖屏)
- lg:  ≥ 1024px (平板横屏/小笔记本)
- xl:  ≥ 1280px (桌面显示器)
```

### 2️⃣ Web服务器层 (Nginx)

**版本**: Nginx 1.20.1

**职责**:
- 🔒 SSL/TLS终止 (HTTPS加密)
- 🔄 HTTP自动重定向到HTTPS
- ⚡ 反向代理 (前端/后端)
- 📦 Gzip压缩
- 📝 访问日志记录
- 🛡️ 安全头部设置

**配置文件**: `/etc/nginx/conf.d/vietbeauty.conf`

**端口监听**:
```
80  (HTTP)  → 自动重定向到 443
443 (HTTPS) → SSL加密访问
```

**代理规则**:
```nginx
location / {
    → 代理到前端SSR服务 (127.0.0.1:5001)
}

location /api {
    → 代理到后端API服务 (127.0.0.1:5002)
}
```

**SSL证书**:
- 颁发机构: Let's Encrypt
- 证书类型: RSA 2048位
- 覆盖域名: vietbeauty.top, www.vietbeauty.top
- 自动续期: certbot-renew.timer
- 证书路径: `/etc/letsencrypt/live/vietbeauty.top/`

### 3️⃣ 前端服务层 (Astro SSR)

**技术栈**:
- 框架: Astro v5.14.1
- 适配器: @astrojs/node (standalone)
- 运行时: Node.js
- 样式: Tailwind CSS v3.4.18
- 语言: TypeScript
- 构建: Vite

**服务配置**:
- 服务名: `vietnam-medical.service`
- 工作目录: `/root/越南医疗整形项目`
- 启动命令: `node ./dist/server/entry.mjs`
- 监听端口: `5001`
- 进程管理: systemd
- 自动重启: ✅ (Restart=always)
- 开机自启: ✅ (enabled)

**页面结构**:
```
src/pages/
├── index.astro              # 首页
├── sharing.astro            # 用户分享列表 (分页36/页)
├── sharing/[id].astro       # 用户分享详情
├── knowledge.astro          # 知识问答列表 (分页36/页)
├── knowledge/[id].astro     # 知识问答详情
├── reviews.astro            # 医院介绍列表 (分页36/页)
├── reviews/[id].astro       # 医院详情页
├── services.astro           # 服务内容 (6大服务)
└── contact.astro            # 联系我们
```

**组件系统**:
```
src/components/
└── Navigation.astro         # 导航栏组件
    - 动态高亮当前页面
    - 响应式菜单
    - 6个主导航链接
```

**布局系统**:
```
src/layouts/
└── Layout.astro             # 主布局
    - SEO元数据
    - 全局样式引入
    - 导航和页脚
```

**样式系统**:
```
src/styles/
└── global.css               # 全局样式
    - Cursor黑色主题变量
    - 玻璃拟态效果 (.glass)
    - 媒体卡片样式 (.media-card)
    - 按钮样式 (.btn-primary/secondary)
    - 渐变文字效果
    - 3D卡片效果
```

**工具函数**:
```
src/utils/
└── api.js                   # API调用封装
    - userShareAPI
    - knowledgeAPI
    - hospitalAPI
```

**构建产物**:
```
dist/
├── client/                  # 客户端资源 (CSS, JS)
└── server/
    └── entry.mjs            # SSR服务入口
```

### 4️⃣ 后端服务层 (Express API)

**技术栈**:
- 框架: Express v4.21.2
- 运行时: Node.js
- ORM: Sequelize v6.37.7
- 数据库: SQLite3 v5.1.7
- 验证: Joi v17.13.3
- 日志: Winston v3.18.3
- 语言: JavaScript (ES Modules)

**服务配置**:
- 服务名: `vietnam-medical-backend.service`
- 工作目录: `/root/越南医疗整形项目/backend`
- 启动命令: `node src/server.js`
- 监听端口: `5002`
- 进程管理: systemd
- 自动重启: ✅ (Restart=always)
- 开机自启: ✅ (enabled)

**目录结构**:
```
backend/
├── src/
│   ├── api/                 # API路由层
│   │   ├── routes.js        # 主路由配置
│   │   ├── userShareRoutes.js    # 用户分享API
│   │   ├── knowledgeRoutes.js    # 知识问答API
│   │   ├── hospitalRoutes.js     # 医院信息API
│   │   └── webhookRoutes.js      # N8N Webhook集成
│   ├── models/              # 数据模型层
│   │   ├── index.js         # Sequelize配置
│   │   ├── UserShare.js     # 用户分享模型
│   │   ├── Knowledge.js     # 知识问答模型
│   │   ├── Hospital.js      # 医院信息模型
│   │   ├── Service.js       # 服务内容模型
│   │   └── Contact.js       # 联系记录模型
│   ├── scripts/             # 脚本工具
│   │   └── init-database.js # 数据库初始化
│   ├── utils/               # 工具函数
│   │   └── logger.js        # Winston日志配置
│   └── server.js            # Express服务入口
├── data/                    # 数据目录
│   ├── medical.db           # SQLite数据库
│   └── backup/              # 数据库备份
├── logs/                    # 日志目录
└── package.json             # 依赖配置
```

**API端点设计**:
```
GET  /health                      # 健康检查
GET  /api/info                    # API信息

# 用户分享
GET  /api/user-shares             # 获取列表 (支持分页/筛选)
GET  /api/user-shares/:id         # 获取详情 (自动+1浏览数)
POST /api/user-shares             # 创建分享
POST /api/user-shares/n8n         # N8N专用接口
POST /api/user-shares/:id/like    # 点赞

# 知识问答
GET  /api/knowledge               # 获取列表 (支持分页/筛选)
GET  /api/knowledge/:id           # 获取详情 (自动+1浏览数)
POST /api/knowledge               # 创建问答
POST /api/knowledge/n8n           # N8N专用接口
POST /api/knowledge/:id/like      # 点赞

# 医院信息
GET  /api/hospitals               # 获取列表 (支持城市筛选)
GET  /api/hospitals/:id           # 获取详情 (自动+1浏览数)
POST /api/hospitals               # 创建医院

# Webhook集成
POST /api/webhooks/n8n            # 通用N8N接口
POST /api/webhooks/batch          # 批量处理
GET  /api/webhooks/sync-status    # 数据统计
```

**中间件栈**:
```javascript
1. Helmet          # 安全头部
2. CORS            # 跨域配置
3. Morgan          # HTTP日志
4. Express.json()  # JSON解析
5. Compression     # Gzip压缩
6. Rate Limit      # API限流 (15分钟100次)
7. 路由处理
8. 错误处理
```

### 5️⃣ 数据持久层 (SQLite)

**数据库信息**:
- 类型: SQLite3
- 文件: `/root/越南医疗整形项目/backend/data/medical.db`
- 大小: ~2.7MB
- ORM: Sequelize

**数据表设计**:

#### user_shares (用户分享)
```
字段: id, title, content, author_name, surgery_type, 
      hospital_name, rating, like_count, view_count, 
      created_at, updated_at
索引: id (主键), created_at, surgery_type
```

#### knowledge (知识问答)
```
字段: id, question, answer, category, doctor_name, 
      like_count, view_count, created_at, updated_at
索引: id (主键), created_at, category
```

#### hospitals (医院信息)
```
字段: id, name, description, address, city, district,
      phone, email, website, rating, review_count,
      specialties (JSON), services (JSON), 
      facilities (JSON), certifications (JSON),
      level, type, status, created_at, updated_at
索引: id (主键), city, rating
数据量: 122家医院
```

#### services (服务内容)
```
字段: id, name, description, category, price_min, 
      price_max, features (JSON), status
```

#### contacts (联系记录)
```
字段: id, name, email, phone, subject, message,
      inquiry_type, status, created_at
```

**数据备份策略**:
```bash
# 自动备份 (建议设置cron)
cp data/medical.db data/backup/medical_$(date +%Y%m%d_%H%M%S).db

# 数据库优化
sqlite3 data/medical.db "VACUUM;"
```

## 🔄 数据流架构

### 完整请求流程

```
┌─────────────────────────────────────────────────────────────┐
│                    完整请求链路                              │
└─────────────────────────────────────────────────────────────┘

用户浏览器
    │
    │ 1. 发起HTTPS请求
    │    https://vietbeauty.top/sharing
    ▼
Nginx (443)
    │
    │ 2. SSL解密
    │ 3. 反向代理
    │    → http://127.0.0.1:5001/sharing
    ▼
前端SSR (5001)
    │
    │ 4. 路由匹配
    │    → src/pages/sharing.astro
    │
    │ 5. 获取数据
    │    → fetch('http://127.0.0.1:5002/api/user-shares')
    ▼
后端API (5002)
    │
    │ 6. 路由处理
    │    → userShareRoutes.js
    │
    │ 7. 数据查询
    │    → UserShare.findAll()
    ▼
SQLite数据库
    │
    │ 8. 返回数据
    │    ← [{id:1, title:"..."}, ...]
    ▼
后端API (5002)
    │
    │ 9. 封装响应
    │    ← {success:true, data:[...], pagination:{...}}
    ▼
前端SSR (5001)
    │
    │ 10. 渲染页面
    │     → Astro组件渲染 + Tailwind样式
    │
    │ 11. 生成HTML
    │     ← 完整HTML文档
    ▼
Nginx (443)
    │
    │ 12. Gzip压缩
    │ 13. SSL加密
    │     ← HTTP/2 200 OK
    ▼
用户浏览器
    │
    │ 14. 渲染显示
    └─→ 用户看到页面
```

### API调用流程

**前端调用后端**:
```javascript
// src/utils/api.js
const API_BASE_URL = 'http://127.0.0.1:5002/api';

// 1. 前端页面调用
const response = await userShareAPI.getList({
  page: 1,
  limit: 36,
  status: 'published'
});

// 2. fetch发送HTTP请求
fetch('http://127.0.0.1:5002/api/user-shares?page=1&limit=36')

// 3. 后端Express路由处理
router.get('/user-shares', async (req, res) => {
  // 参数验证
  // 数据库查询
  // 返回响应
});

// 4. Sequelize ORM查询
const shares = await UserShare.findAll({
  where: { status: 'published' },
  limit: 36,
  offset: 0,
  order: [['created_at', 'DESC']]
});

// 5. 返回给前端
return {
  success: true,
  data: shares,
  pagination: { page: 1, total: 100, pages: 3 }
}
```

### N8N集成数据流

```
N8N工作流
    │
    │ POST请求
    │ Content-Type: application/json
    ▼
后端Webhook (5002)
    │
    │ /api/webhooks/n8n
    │ 或 /api/knowledge/n8n
    │ 或 /api/user-shares/n8n
    ▼
数据验证 (Joi)
    │
    │ 最简字段：
    │ - knowledge: {question, answer}
    │ - user_share: {title, content}
    ▼
智能填充
    │
    │ - 自动分类识别
    │ - 默认值填充
    │ - external_id去重
    ▼
Sequelize ORM
    │
    │ 创建或更新记录
    ▼
SQLite数据库
    │
    │ 持久化存储
    └─→ 前端页面立即可见
```

## 🎨 前端架构详解

### 页面渲染流程

```
┌─────────────────────────────────────────────────────────────┐
│                   SSR渲染流程                                │
└─────────────────────────────────────────────────────────────┘

1. 用户访问 /sharing
        ↓
2. Astro路由匹配 src/pages/sharing.astro
        ↓
3. 执行顶层代码 (---  ---)
   - 解析URL参数 (page)
   - 调用后端API获取数据
   - 数据预处理
        ↓
4. 渲染组件模板
   - Layout.astro (主布局)
   - Navigation.astro (导航栏)
   - 页面内容 (媒体卡片)
        ↓
5. 应用Tailwind样式
   - 响应式类名
   - 主题颜色变量
   - 动画效果
        ↓
6. 生成完整HTML
   - 包含内联CSS
   - 包含JavaScript (如果有)
   - SEO优化标签
        ↓
7. 返回给Nginx
        ↓
8. Nginx处理
   - Gzip压缩
   - 添加安全头部
   - SSL加密
        ↓
9. 发送给用户浏览器
        ↓
10. 浏览器渲染显示
```

### 媒体块设计系统

**两种媒体块类型**:

#### 自适应高度媒体块 (sharing.astro)
```
特点:
- 高度根据内容自适应
- 标题: line-clamp-2
- 内容: line-clamp-3
- 适用场景: 内容长度不一的列表

CSS:
.media-card {
  background: linear-gradient(145deg, rgba(255,255,255,0.1), ...);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  transition: all 0.3s ease;
}
```

#### 固定高度媒体块 (knowledge.astro)
```
特点:
- 固定高度: 340px
- Flexbox布局: flex flex-col
- 底部自动对齐: mt-auto
- 适用场景: 需要网格整齐对齐

布局结构:
┌────────────────────┐
│ 标题区 (flex-shrink-0)
├────────────────────┤
│ 内容区 (flex-grow)
├────────────────────┤
│ 底部区 (mt-auto)   │ ← 自动推到底部
└────────────────────┘
```

### 响应式设计

**网格布局**:
```html
<!-- 3列响应式网格 -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
  <!-- 卡片内容 -->
</div>

断点说明:
- 移动端 (< 768px):   1列
- 平板 (768-1023px):  2列
- 桌面 (≥ 1024px):    3列
```

### 导航高亮逻辑

```typescript
const currentPath = Astro.url.pathname;

const isActive = (path: string) => {
  if (path === '/') {
    return currentPath === '/';     // 首页精确匹配
  }
  return currentPath.startsWith(path); // 其他页面前缀匹配
};

// 详情页也会高亮对应的列表页
// 例如: /sharing/1 会高亮 "用户分享" 导航
```

## 🗄️ 后端架构详解

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    后端三层架构                              │
└─────────────────────────────────────────────────────────────┘

路由层 (Routes)
    │ - 定义API端点
    │ - 参数验证
    │ - 权限检查
    ▼
业务逻辑层 (Models + Logic)
    │ - 数据处理
    │ - 业务规则
    │ - 数据验证
    ▼
数据访问层 (Sequelize ORM)
    │ - SQL生成
    │ - 事务管理
    │ - 连接池
    ▼
数据库层 (SQLite)
    │ - 数据存储
    │ - 索引查询
    │ - 持久化
```

### 数据模型关系

```
Hospital (医院)
    │
    │ hospital_name (外键引用)
    ├─→ UserShare (用户分享)
    │
    │ hospital_name (外键引用)
    └─→ Knowledge (知识问答)

分类体系:
- 用户分享: surgery_type (智能识别)
- 知识问答: category (6大分类)
- 医院信息: city (5个城市)
```

### 智能分类识别

**用户分享自动分类**:
```javascript
关键词映射:
"mũi|nâng mũi|sụn mũi"        → "Phẫu thuật mũi"
"mắt|mí mắt|cắt mí"            → "Phẫu thuật mắt"
"khuôn mặt|gọt mặt|v-line"     → "Đường nét khuôn mặt"
"ngực|nâng ngực|hút mỡ"        → "Thẩm mỹ cơ thể"
"da|laser|filler|botox"        → "Làm đẹp da"
```

### 日志系统

**Winston日志配置**:
```javascript
级别: error, warn, info, debug
输出:
- Console (开发环境)
- File logs/ (生产环境)
- Journal (systemd)

日志格式:
{
  timestamp: "2025-10-10 20:30:15",
  level: "info",
  message: "用户分享创建成功",
  service: "vietnam-medical-backend",
  data: { id: 123, title: "..." }
}
```

## 🚀 部署架构

### 完整部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                   deploy.sh 部署流程                         │
└─────────────────────────────────────────────────────────────┘

开发者执行
    │
    │ ./deploy.sh
    ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│    后端部署 (1-7步)      │  │    前端部署 (8-12步)     │
├──────────────────────────┤  ├──────────────────────────┤
│ 1. 停止服务              │  │ 8. 停止服务              │
│ 2. npm install           │  │ 9. npm run build         │
│ 3. 创建目录              │  │ 10. systemd配置          │
│ 4. 初始化数据库          │  │ 11. 启动服务             │
│ 5. systemd配置           │  │ 12. 检查状态             │
│ 6. 启动服务              │  │                          │
│ 7. 检查状态              │  │                          │
└──────────────────────────┘  └──────────────────────────┘
            │                             │
            └─────────┬───────────────────┘
                      ▼
            ┌──────────────────────────┐
            │  健康检查 (13-15步)      │
            ├──────────────────────────┤
            │ 13. 等待5秒              │
            │ 14. 检查后端API          │
            │ 15. 检查前端服务         │
            └──────────────────────────┘
                      │
                      ▼
            ┌──────────────────────────┐
            │  显示完成信息            │
            ├──────────────────────────┤
            │ - 官方域名               │
            │ - SSL状态                │
            │ - 服务命令               │
            └──────────────────────────┘
                      │
                      ▼
                 部署完成！
          服务自动运行和监控
```

### 构建流程

**前端构建 (npm run build)**:
```
源代码 (src/)
    ↓
TypeScript编译
    ↓
Astro组件编译
    ↓
Tailwind CSS处理
    - 扫描HTML类名
    - 生成最小CSS
    - PurgeCSS优化
    ↓
Vite打包优化
    - 代码分割
    - Tree shaking
    - 资源压缩
    ↓
生成产物 (dist/)
    ├── client/ (静态资源)
    └── server/ (SSR服务)
        └── entry.mjs
```

## 🔐 安全架构

### 多层安全防护

```
┌─────────────────────────────────────────────────────────────┐
│                    安全防护体系                              │
└─────────────────────────────────────────────────────────────┘

第1层: SSL/TLS加密
├─ Let's Encrypt证书
├─ TLS 1.2/1.3
└─ 强制HTTPS

第2层: Nginx安全
├─ 隐藏版本号
├─ 限制请求大小
├─ 超时设置
└─ 访问日志

第3层: 后端安全
├─ Helmet安全头部
├─ CORS跨域限制
├─ Rate Limit限流 (15分钟100次)
├─ Joi输入验证
└─ SQL注入防护 (ORM)

第4层: 数据安全
├─ 数据库文件权限控制
├─ 定期备份
├─ 敏感信息不记录日志
└─ 外部ID防重复
```

### 访问控制

**CORS配置**:
```javascript
允许来源: 
- http://localhost:4321 (开发)
- http://127.0.0.1:5001 (生产)
- https://vietbeauty.top (域名)

允许方法: GET, POST, PUT, DELETE
允许头部: Content-Type, Authorization
```

**API限流**:
```
时间窗口: 15分钟
请求限制: 100次/IP
超限响应: 429 Too Many Requests
```

## 📈 性能优化架构

### 构建时优化

```
┌─────────────────────────────────────────────────────────────┐
│                   构建优化策略                               │
└─────────────────────────────────────────────────────────────┘

代码优化:
├─ Tree Shaking (移除未使用代码)
├─ Code Splitting (按路由分割)
├─ Minification (代码压缩)
└─ TypeScript编译优化

样式优化:
├─ Tailwind CSS PurgeCSS (移除未使用样式)
├─ CSS压缩
└─ Critical CSS内联

资源优化:
├─ 图片优化 (WebP格式)
├─ 字体子集化
└─ 静态资源指纹化
```

### 运行时优化

```
Nginx层:
├─ Gzip压缩 (文本资源压缩80%)
├─ 浏览器缓存 (静态资源)
├─ Keep-Alive连接复用
└─ HTTP/2支持

前端层:
├─ SSR服务器渲染 (首屏快速)
├─ 懒加载图片
├─ 按需加载组件
└─ 客户端缓存

后端层:
├─ SQLite高效查询
├─ 索引优化
├─ 连接池管理
└─ 响应压缩

数据库层:
├─ 索引优化
├─ 查询优化
├─ VACUUM整理
└─ WAL模式
```

## 🔧 进程管理架构

### systemd服务管理

```
┌─────────────────────────────────────────────────────────────┐
│                   systemd服务架构                            │
└─────────────────────────────────────────────────────────────┘

系统启动
    │
    ▼
network.target
    │
    ├──→ nginx.service
    │    - 启动Nginx
    │    - 监听80/443
    │
    ├──→ vietnam-medical-backend.service
    │    - 启动后端API
    │    - 监听5002
    │    - 连接数据库
    │
    └──→ vietnam-medical.service
         - 启动前端SSR
         - 监听5001
         - 连接后端API

所有服务配置:
- Restart=always (自动重启)
- RestartSec=10 (重启间隔10秒)
- WantedBy=multi-user.target (开机自启)
```

### 定时任务

```
certbot-renew.timer
    │
    ├─ 每天检查证书
    ├─ 到期前30天自动续期
    └─ 续期后自动重载Nginx
```

## 📦 依赖管理架构

### 前端依赖

```json
{
  "核心框架": {
    "astro": "^5.14.1",
    "@astrojs/node": "^9.0.1",
    "@astrojs/tailwind": "^5.1.4"
  },
  "样式": {
    "tailwindcss": "^3.4.18"
  },
  "开发工具": {
    "typescript": "*",
    "vite": "*"
  }
}
```

### 后端依赖

```json
{
  "核心框架": {
    "express": "^4.21.2",
    "sequelize": "^6.37.7",
    "sqlite3": "^5.1.7"
  },
  "安全": {
    "helmet": "^7.2.0",
    "cors": "^2.8.5",
    "express-rate-limit": "^7.5.1"
  },
  "工具": {
    "joi": "^17.13.3",
    "winston": "^3.18.3",
    "axios": "^1.12.2",
    "compression": "^1.8.1"
  }
}
```

## 🌐 网络架构

### 网络拓扑

```
                    Internet (公网)
                         │
                         │ DNS解析
                         │ vietbeauty.top → 47.237.79.9
                         ▼
                  ┌──────────────┐
                  │  防火墙      │
                  │  允许: 80,   │
                  │       443    │
                  └──────────────┘
                         │
                         ▼
                  ┌──────────────┐
                  │   Nginx      │
                  │   80/443     │
                  └──────────────┘
                         │
              ┌──────────┴──────────┐
              ▼                     ▼
       ┌─────────────┐      ┌─────────────┐
       │ 前端服务    │      │ 后端服务    │
       │ 127.0.0.1   │      │ 127.0.0.1   │
       │ :5001       │◄────►│ :5002       │
       └─────────────┘      └─────────────┘
                                    │
                                    ▼
                            ┌─────────────┐
                            │  SQLite DB  │
                            │  medical.db │
                            └─────────────┘
```

### 端口绑定策略

| 端口 | 服务 | 绑定地址 | 访问范围 |
|------|------|----------|----------|
| 80 | Nginx | 0.0.0.0 | 公网可访问 |
| 443 | Nginx | 0.0.0.0 | 公网可访问 |
| 5001 | 前端SSR | 0.0.0.0 | 内网+公网 |
| 5002 | 后端API | 0.0.0.0 | 内网+公网 |

**安全建议**: 可以将5001和5002改为127.0.0.1，仅允许Nginx代理访问

## 📊 监控和日志架构

### 日志分类

```
┌─────────────────────────────────────────────────────────────┐
│                    日志系统架构                              │
└─────────────────────────────────────────────────────────────┘

系统日志 (systemd journal)
├─ vietnam-medical.service
│  └─ 前端SSR启动/错误日志
├─ vietnam-medical-backend.service
│  └─ 后端API启动/错误日志
├─ nginx.service
│  └─ Nginx启动/错误日志
└─ certbot-renew.service
   └─ SSL证书续期日志

应用日志
├─ /root/越南医疗整形项目/backend/logs/
│  ├─ combined.log (所有日志)
│  └─ error.log (错误日志)

Web服务器日志
├─ /var/log/nginx/vietbeauty_access.log
│  └─ HTTP访问记录
└─ /var/log/nginx/vietbeauty_error.log
   └─ Nginx错误记录

SSL证书日志
└─ /var/log/letsencrypt/letsencrypt.log
   └─ 证书申请/续期日志
```

### 监控指标

```
服务可用性:
- 前端服务状态 (systemctl)
- 后端服务状态 (systemctl)
- Nginx服务状态 (systemctl)

性能指标:
- 响应时间
- 内存占用
- CPU使用率
- 数据库大小

业务指标:
- API调用次数
- 页面浏览数
- 点赞数
- 数据增长
```

## 🔄 数据同步架构

### N8N集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                    N8N工作流集成                             │
└─────────────────────────────────────────────────────────────┘

N8N工作流 (外部系统)
    │
    │ HTTP POST请求
    ▼
Webhook端点
    │
    ├─→ /api/webhooks/n8n (通用接口)
    │   - 支持多种类型 (type: user_share, knowledge, hospital)
    │
    ├─→ /api/knowledge/n8n (知识问答专用)
    │   - 最简接口: {question, answer}
    │
    └─→ /api/user-shares/n8n (用户分享专用)
        - 最简接口: {title, content}
        - 自动填充: author_name, surgery_type, rating

防重复机制:
- external_id字段
- 相同ID自动更新而非新建

数据验证:
- Joi schema验证
- 必填字段检查
- 数据类型转换
    ↓
数据存储
    ↓
前端自动可见
```

## 🎯 页面架构详解

### 六大页面模块

#### 1. 首页 (index.astro)
```
功能模块:
├─ Hero区域
│  ├─ 主标题和副标题
│  ├─ "开始咨询" → /contact
│  └─ "了解更多" → /reviews
├─ 统计数据展示 (500+医院, 10000+成功案例)
├─ 用户分享预览 (最新6条)
├─ 知识问答预览 (最新6条)
├─ 医院推荐 (评分最高6家)
└─ 服务内容概览 (6大服务)

数据获取:
- userShareAPI.getList({limit: 6, sort: 'created_at'})
- knowledgeAPI.getList({limit: 6, sort: 'created_at'})
- hospitalAPI.getList({limit: 6, sort: 'rating'})
```

#### 2. 用户分享 (sharing.astro)
```
页面特点:
- 3列网格布局 (响应式)
- 自适应高度媒体块
- 分页导航 (36条/页)
- 点赞和浏览数显示

数据获取:
- GET /api/user-shares?page={page}&limit=36&status=published
- 按创建时间倒序排列

详情页 (sharing/[id].astro):
- 完整内容展示
- 点赞功能 (POST /api/user-shares/:id/like)
- 相关分享推荐
- 浏览数自动+1
```

#### 3. 知识问答 (knowledge.astro)
```
页面特点:
- 3列网格布局
- 固定高度340px媒体块
- 分类筛选 (6个分类)
- 分页导航 (36条/页)

数据获取:
- GET /api/knowledge?page={page}&limit=36&category={category}

详情页 (knowledge/[id].astro):
- 完整问答展示
- 医生信息显示
- 点赞功能
- 相关问答推荐
```

#### 4. 医院介绍 (reviews.astro)
```
页面特点:
- 3列网格布局
- 城市筛选 (5个城市)
- 评分星级显示
- 分页导航 (36条/页)

数据获取:
- GET /api/hospitals?page={page}&limit=36&city={city}

详情页 (reviews/[id].astro):
- 医院基本信息
- 联系方式 (电话/邮箱/网站)
- 4个信息媒体块:
  * 提供服务 (services)
  * 设施设备 (facilities)
  * 资质认证 (certifications)
  * 用户评价
- 相关医院推荐
```

#### 5. 服务内容 (services.astro)
```
页面特点:
- 6个核心服务展示
- 固定高度一致的卡片
- 每个服务6个功能点
- 3个关键数据高亮

服务列表:
1. 风险评估与美容套餐咨询
2. 美容咨询与疑问解答
3. 医院预约支持
4. 医院信息验证
5. 医疗费用分期咨询
6. 投诉支持与权益保护

布局:
- 3列网格 (lg:grid-cols-3)
- Flexbox垂直布局 (flex flex-col h-full)
- 底部自动对齐 (mt-auto)
```

#### 6. 联系我们 (contact.astro)
```
页面特点:
- 2列横向布局
- 左侧: 联系信息
- 右侧: 办公地址

联系方式:
├─ 📞 Hotline 24/7
├─ 📧 Email地址
├─ 💬 WeChat咨询
└─ ⏰ 工作时间

办公地址:
├─ 🏢 TP.HCM办公室
├─ 🏢 Hà Nội办公室
└─ 🏢 Đà Nẵng办公室
```

## 🎨 设计系统架构

### Cursor黑色主题

**颜色变量**:
```css
:root {
  --cursor-bg: #0d1117;           /* 背景色 */
  --cursor-surface: #161b22;      /* 表面色 */
  --cursor-border: #21262d;       /* 边框色 */
  --cursor-text: #f0f6fc;         /* 主文字色 */
  --cursor-text-muted: #8b949e;   /* 次要文字色 */
  --cursor-accent: #58a6ff;       /* 强调色-蓝 */
  --cursor-accent-hover: #79c0ff; /* 强调悬停 */
  --cursor-success: #3fb950;      /* 成功色-绿 */
  --cursor-warning: #d29922;      /* 警告色-黄 */
  --cursor-error: #f85149;        /* 错误色-红 */
}
```

**组件样式类**:
```css
.glass              /* 玻璃拟态效果 */
.media-card         /* 媒体卡片 */
.btn-primary        /* 主按钮 */
.btn-secondary      /* 次要按钮 */
.gradient-text-blue /* 蓝色渐变文字 */
.card-3d            /* 3D卡片效果 */
```

### 渐变配色方案

**服务模块配色**:
```
服务1 (风险评估): from-blue-400 to-purple-400
服务2 (咨询解答): from-green-400 to-teal-400
服务3 (预约支持): from-pink-400 to-rose-400
服务4 (信息验证): from-orange-400 to-amber-400
服务5 (费用咨询): from-cyan-400 to-blue-400
服务6 (权益保护): from-red-400 to-pink-400
```

## 🔄 开发到生产流程

### 完整工作流

```
┌─────────────────────────────────────────────────────────────┐
│              开发 → 测试 → 构建 → 部署 → 监控                 │
└─────────────────────────────────────────────────────────────┘

1. 本地开发
   ├─ npm run dev (前端 localhost:4321)
   ├─ 修改代码
   └─ 实时预览

2. 代码提交
   ├─ Git commit
   └─ 推送到仓库

3. 生产构建
   ├─ npm run build (前端)
   ├─ 生成 dist/ 目录
   └─ SSR入口文件

4. 部署执行
   ├─ ./deploy.sh
   ├─ 后端部署 (1-7步)
   ├─ 前端部署 (8-12步)
   └─ 健康检查 (13-15步)

5. 服务启动
   ├─ systemd启动服务
   ├─ Nginx代理请求
   └─ SSL加密传输

6. 监控运维
   ├─ journalctl查看日志
   ├─ systemctl查看状态
   └─ 数据库备份
```

### 热更新流程

**前端热更新**:
```bash
# 1. 停止服务
systemctl stop vietnam-medical.service

# 2. 构建
npm run build

# 3. 启动服务
systemctl start vietnam-medical.service

# 总耗时: ~15秒
```

**后端热更新**:
```bash
# 1. 停止服务
systemctl stop vietnam-medical-backend.service

# 2. 安装依赖（如有更新）
npm install

# 3. 启动服务
systemctl start vietnam-medical-backend.service

# 总耗时: ~5秒
```

**零停机更新** (未来优化):
- 使用PM2或Docker
- 蓝绿部署
- 健康检查自动切换

## 💾 数据架构

### 数据库ER图

```
┌─────────────────────────────────────────────────────────────┐
│                    数据库实体关系                            │
└─────────────────────────────────────────────────────────────┘

hospitals (122条)
    │
    │ hospital_name (软关联)
    ├──────────────────┐
    │                  │
    ▼                  ▼
user_shares       knowledge
(用户分享)        (知识问答)
    │                  │
    │ surgery_type     │ category
    │ (智能识别)       │ (6大分类)
    │                  │
    ▼                  ▼
点赞/浏览统计    点赞/浏览统计
like_count       like_count
view_count       view_count

services (服务内容)
    - 独立表，暂无关联

contacts (联系记录)
    - 独立表，记录咨询
```

### 数据增长预测

```
当前数据量:
├─ hospitals: 122条 (相对稳定)
├─ knowledge: ~50条 (持续增长)
├─ user_shares: ~100条 (持续增长)
└─ 数据库大小: 2.7MB

预计增长:
- 每月新增问答: 50-100条
- 每月新增分享: 100-200条
- 年增长: ~10MB
- 3年预计: ~30MB (SQLite轻松应对)
```

## 🚀 扩展性架构

### 水平扩展方案

**当前架构** (单服务器):
```
1台服务器
├─ Nginx
├─ 前端SSR (1实例)
├─ 后端API (1实例)
└─ SQLite
```

**扩展方案1** (多实例):
```
1台服务器 + PM2
├─ Nginx (负载均衡)
├─ 前端SSR (2-4实例)
├─ 后端API (2-4实例)
└─ SQLite
```

**扩展方案2** (多服务器):
```
负载均衡器
    │
    ├─→ Web服务器1 (前端+后端)
    ├─→ Web服务器2 (前端+后端)
    └─→ Web服务器3 (前端+后端)
         │
         └─→ PostgreSQL/MySQL (共享数据库)
```

### 未来优化方向

**性能优化**:
- [ ] CDN加速静态资源
- [ ] Redis缓存热点数据
- [ ] 数据库读写分离
- [ ] 图片CDN存储

**功能扩展**:
- [ ] 用户认证系统
- [ ] 实时聊天客服
- [ ] 在线预约系统
- [ ] 支付集成
- [ ] 多语言支持

**技术升级**:
- [ ] 迁移到PostgreSQL
- [ ] Docker容器化
- [ ] Kubernetes编排
- [ ] 微服务架构

## 📱 移动端优化架构

### 响应式策略

```
设备检测
    │
    ├─→ 移动端 (< 768px)
    │   ├─ 1列布局
    │   ├─ 汉堡菜单
    │   ├─ 触摸优化
    │   └─ 精简内容
    │
    ├─→ 平板 (768-1023px)
    │   ├─ 2列布局
    │   ├─ 适中间距
    │   └─ 混合导航
    │
    └─→ 桌面 (≥ 1024px)
        ├─ 3列布局
        ├─ 完整导航
        └─ 丰富交互
```

### PWA支持 (未来)

**渐进式Web应用**:
- [ ] Service Worker离线缓存
- [ ] 添加到主屏幕
- [ ] 推送通知
- [ ] 后台同步

## 🔧 开发工具架构

### 开发环境

```
本地开发:
├─ npm run dev (前端)
│  └─ http://localhost:4321
├─ npm run dev (后端)
│  └─ http://localhost:5002
└─ 热重载开发

代码质量:
├─ TypeScript类型检查
├─ ESLint代码规范
└─ Prettier格式化

调试工具:
├─ 浏览器DevTools
├─ Astro Dev Toolbar
└─ VS Code调试器
```

### 构建工具链

```
Vite (构建工具)
    │
    ├─→ TypeScript编译
    ├─→ Tailwind CSS处理
    ├─→ 资源优化
    └─→ 代码分割

Astro (框架)
    │
    ├─→ 组件编译
    ├─→ 路由生成
    ├─→ SSR配置
    └─→ 静态优化
```

## 📊 技术决策说明

### 为什么选择Astro?

**优势**:
- ✅ 服务器端渲染 (SEO友好)
- ✅ 零JavaScript默认 (性能优秀)
- ✅ 组件化开发
- ✅ 灵活的部署选项
- ✅ TypeScript支持

**适用场景**:
- 内容为主的网站 ✓
- SEO要求高 ✓
- 性能要求高 ✓

### 为什么选择SQLite?

**优势**:
- ✅ 零配置 (无需数据库服务器)
- ✅ 单文件存储 (易于备份)
- ✅ 高性能读取
- ✅ 轻量级 (适合中小数据量)
- ✅ ACID事务支持

**适用场景**:
- 读多写少 ✓
- 数据量 < 100GB ✓
- 单服务器部署 ✓

### 为什么选择Nginx?

**优势**:
- ✅ 高性能反向代理
- ✅ SSL/TLS终止
- ✅ Gzip压缩
- ✅ 负载均衡能力
- ✅ 稳定可靠

## 🛡️ 容错和恢复架构

### 自动恢复机制

```
服务异常
    │
    ▼
systemd检测
    │
    ▼
等待10秒 (RestartSec=10)
    │
    ▼
自动重启服务
    │
    ├─→ 成功 → 继续运行
    └─→ 失败 → 继续重试 (无限次)
```

### 数据备份策略

**建议备份频率**:
```
数据库:
- 每日备份: 保留7天
- 每周备份: 保留4周
- 每月备份: 保留12月

配置文件:
- Git版本控制
- 定期导出备份

日志:
- journalctl自动管理
- 保留最近7-30天
```

## 📞 系统集成架构

### 外部集成

```
N8N工作流平台
    │ Webhook
    ▼
后端API
    │
    ├─→ 数据验证
    ├─→ 智能分类
    ├─→ 去重处理
    └─→ 数据入库
         ↓
    前端实时展示

未来集成:
- 支付平台 (VNPay, MoMo)
- 短信平台 (SMS验证)
- 邮件服务 (SendGrid)
- 分析工具 (Google Analytics)
```

## 📈 监控告警架构 (规划)

### 监控指标

```
基础监控:
├─ 服务可用性 (uptime)
├─ CPU使用率
├─ 内存使用率
└─ 磁盘空间

应用监控:
├─ API响应时间
├─ 错误率
├─ 请求量
└─ 并发数

业务监控:
├─ 新增用户分享
├─ 新增知识问答
├─ 页面浏览量
└─ API调用统计
```

### 告警策略 (未来)

```
告警级别:
├─ Critical: 服务宕机
├─ Warning: CPU>80%, 内存>85%
└─ Info: SSL证书将过期

通知渠道:
├─ Email
├─ 短信
└─ Webhook (钉钉/飞书)
```

## 🎯 架构优势总结

### 技术优势

1. **高性能**
   - Astro SSR快速首屏
   - Nginx高效代理
   - SQLite高速查询
   - Gzip压缩传输

2. **高可用**
   - systemd自动重启
   - 开机自启动
   - 证书自动续期
   - 多层容错

3. **易维护**
   - 一键部署脚本
   - 完善的日志系统
   - 清晰的目录结构
   - 详细的文档

4. **安全性**
   - HTTPS加密
   - API限流
   - 输入验证
   - SQL注入防护

5. **可扩展**
   - 模块化设计
   - 前后端分离
   - RESTful API
   - Webhook集成

### 成本优势

- 💰 **低成本**: 单服务器运行，无需复杂基础设施
- 🚀 **快速部署**: 15秒完成部署
- 🔧 **易于管理**: systemd统一管理
- 📦 **零配置数据库**: SQLite开箱即用

## 📚 相关文档

- [生产环境部署指南](./生产环境部署指南.md) - 完整部署流程
- [前端开发文档](./前端开发文档.md) - 前端技术细节
- [后端开发文档](./后端开发文档.md) - 后端API详解
- [数据库配置文档](./数据库配置开发文档.md) - 数据库设计

---

**文档版本**: v1.3.0  
**最后更新**: 2025-10-10  
**维护团队**: 开发团队  
**官方网站**: https://vietbeauty.top

**说明**: 本文档基于实际生产环境编写，准确反映了项目的真实架构和技术选型。

