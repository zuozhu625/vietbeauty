# 越南医疗整形项目 - 数据库配置开发文档 v3.0

## 📋 目录

- [项目概览](#项目概览)
- [数据库分离说明](#数据库分离说明)
- [系统架构](#系统架构)
- [数据库模型](#数据库模型)
- [数据生成方式](#数据生成方式)
- [API接口](#api接口)
- [N8N集成](#n8n集成)
- [前端页面](#前端页面)
- [重要警告](#重要警告)
- [常见问题](#常见问题)
- [部署运维](#部署运维)

---

## 📊 项目概览

### 基本信息

| 项目 | 信息 |
|------|------|
| **项目名称** | 越南医疗整形项目 |
| **前端地址** | http://47.237.79.9:5001 |
| **后端地址** | http://47.237.79.9:5002 |
| **数据库类型** | SQLite3 |
| **前端数据库** | database.sqlite（越南语网站数据） |
| **智能体数据库** | medical.db（中文训练数据，独立） |
| **前端框架** | Astro (SSR) |
| **后端框架** | Node.js + Express |
| **样式框架** | Tailwind CSS |

### ⚠️ 重要提示

**本项目有两个完全独立的数据库，用途不同，请勿混淆！**

| 数据库 | 文件路径 | 用途 | 语言 | 状态 |
|--------|----------|------|------|------|
| **database.sqlite** | `/backend/data/database.sqlite` | 前端网站展示 | 越南语 | ✅ 在线 |
| **medical.db** | `/backend/data/medical.db` | 智能体训练 | 中文 | ✅ 内部 |

### 数据统计（最新）

| 模块 | database.sqlite | medical.db |
|------|-----------------|------------|
| **医院** | 122家 | 122家（备份） |
| **用户分享** | 367条 | 367条（备份） |
| **知识问答** | DQA+智能体双重生成 | 1,831条中文数据 |
| **服务/联系** | 3条 | - |

### 知识问答生成系统

**双重问答生成系统**：

| 系统 | 用途 | 语言 | 频率 | 数据源 |
|------|------|------|------|--------|
| **DQA系统** | 前端展示 | 越南语 | 每15分钟1条 | 122家医院数据 |
| **拟人化智能体** | 内部训练 | 中文 | 每20分钟1条 | 大模型生成 |

---

## 🔀 数据库分离说明

### 分离目的

为避免数据混淆，确保：
1. 前端只展示越南语内容
2. 智能体只处理中文数据
3. 两者互不干扰，独立运作

### 分离日期

- **操作时间**: 2025-10-26
- **操作原因**: 中文智能体数据误导入，覆盖了越南语问答数据
- **分离方案**: 创建独立的前端数据库，保留智能体数据库

---

## 🏗️ 系统架构

### 完整数据流向

```
┌──────────────────────────────────────────────────────────┐
│                    用户访问前端                           │
│              http://47.237.79.9:5001                     │
└──────────────────────────────────────────────────────────┘
                          ↓
┌──────────────────────────────────────────────────────────┐
│                前端服务 (Astro SSR)                       │
│                    Port: 5001                             │
│  • /reviews (医院) • /knowledge (问答) • /sharing (分享) │
└──────────────────────────────────────────────────────────┘
                          ↓ API调用
┌──────────────────────────────────────────────────────────┐
│             后端服务 (Node.js + Express)                  │
│                    Port: 5002                             │
│  • GET /api/hospitals  • GET /api/knowledge               │
│  • GET /api/user-shares                                   │
│  • POST /api/user-shares/n8n (N8N接入)                   │
└──────────────────────────────────────────────────────────┘
                          ↓
        ┌─────────────────────────────────────┐
        │                                     │
        ↓                                     ↓
┌──────────────────┐              ┌──────────────────┐
│ database.sqlite   │              │   medical.db     │
│  (前端网站)      │              │  (智能体训练)    │
│                  │              │                  │
│ • hospitals      │              │ • knowledge      │
│ • user_shares    │              │   (中文)         │
│ • knowledge      │◄─────────────┤ • knowledge_     │
│   (越南语)       │  DQA+智能体   │   history        │
│ • services       │  双重生成     │                  │
│ • contacts       │              │                  │
└──────────────────┘              └──────────────────┘
        ↑                                     ↑
        │                                     │
   用户分享+N8N                           拟人化智能体
   (N8N输入)                            (Python脚本)
```

### 双重问答生成系统

```
┌──────────────────────────────────────────────────────────┐
│                    DQA系统 (v1.5.0)                       │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │  拟人化优化特性：                                  │   │
│  │  • 15种个性化开场白                               │   │
│  │  • 10种温馨结尾语                                 │   │
│  │  • 14种自然过渡词                                 │   │
│  │  • 16个答案生成方法全覆盖                         │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  频率：每15分钟1条                                       │
│  语言：越南语                                            │
│  数据源：122家医院真实数据                               │
│  输出：database.sqlite → 前端展示                        │
└──────────────────────────────────────────────────────────┘
                                ↓
┌──────────────────────────────────────────────────────────┐
│                拟人化问答生成智能体                        │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │  技术栈：                                        │   │
│  │  • Doubao-Seed-1.6-flash (豆包Flash模型)         │   │
│  │  • Volces Ark API                                │   │
│  │  • Python 3                                      │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  频率：每20分钟1条                                       │
│  语言：中文                                              │
│  数据源：大模型生成                                       │
│  输出：medical.db → 智能体训练                           │
└──────────────────────────────────────────────────────────┘
```

---

## 🤖 数据生成方式

### 1. 医院数据 (hospitals)

**数据来源**: 手工创建  
**数据库**: `database.sqlite`  
**数量**: 122家  
**状态**: ✅ 完成

**生成方式**:
```javascript
// 通过脚本批量添加
node backend/src/scripts/add-hospitals.js
```

**特点**:
- 一次性导入完成
- 数据稳定，不常更新
- 包含完整医院信息（服务、设施、认证等）

---

### 2. 用户分享 (user_shares)

**数据来源**: N8N接口  
**数据库**: `database.sqlite`  
**数量**: 367条（持续增长）  
**状态**: ✅ 运行中

**生成方式**:
```bash
# 通过N8N专用接口提交
POST http://47.237.79.9:5002/api/user-shares/n8n
{
  "title": "分享标题",
  "content": "分享内容"
}
```

**特点**:
- N8N工作流自动提交
- 智能识别手术类型
- 自动填充作者信息

---

### 3. 知识问答 (knowledge) - ⭐ 重点

#### 3.1 DQA系统 - 前端越南语问答

**数据来源**: DQA自动生成（v1.5.0拟人化优化）  
**语言**: 越南语  
**数量**: 动态增长  
**状态**: ✅ 自动化运行

**DQA系统说明**:

| 属性 | 值 |
|------|-----|
| **全称** | Dynamic Q&A (动态问答系统) |
| **功能** | 自动生成越南语医院问答 |
| **数据源** | 122家医院数据 |
| **生成频率** | 每15分钟1条 |
| **每日产量** | 96条问答 |
| **每月产量** | ~2,880条问答 |

**拟人化优化特性**:
- ✅ 15种个性化开场白
- ✅ 10种温馨结尾语
- ✅ 14种自然过渡词
- ✅ 16个答案生成方法全覆盖

**问答类型**:
1. 医院资质问答
2. 医院等级问答
3. 医院服务问答
4. 医院地址问答
5. 医院联系方式问答
6. 医生团队问答

**生成示例**:
```json
{
  "question": "Bệnh viện FV Hospital có giấy phép hợp pháp không?",
  "answer": "Chào bạn! Mình rất vui được tư vấn cho bạn về giấy phép của Bệnh viện FV Hospital.\n\nBệnh viện FV Hospital có đầy đủ giấy phép hoạt động... Nói thêm là, giấy phép được gia hạn định kỳ và tuân thủ các quy định hiện hành. Hy vọng thông tin này hữu ích cho bạn nhé!",
  "category": "Tư vấn bệnh viện",
  "source": "dqa"
}
```

#### 3.2 拟人化问答生成智能体 - 中文训练数据

**数据来源**: 大模型自动生成  
**语言**: 中文  
**数量**: 1,831条（持续增长）  
**状态**: ✅ 自动化运行

**技术栈**:
- **大模型**: Doubao-Seed-1.6-flash (豆包Flash模型)
- **API**: Volces Ark API
- **数据库**: SQLite3
- **语言**: Python 3

**生成特点**:
- ✅ 拟人化表达，语气温暖、专业、有亲和力
- ✅ 患者视角问题，贴近真实咨询场景
- ✅ 专业医学知识，通俗易懂的解释
- ✅ 人文关怀，贴心建议和注意事项

**分类覆盖**:
- 丰胸: 381条
- 五官: 500条
- 产修: 201条
- 吸脂: 298条
- 牙矫: 449条

**生成示例**:
```json
{
  "question": "医生，我生完宝宝快5个月了，肚子还是松垮垮的，摸起来中间那块有点'空落落'的，还有那些红印子（妊娠纹）也没消，我想做产后修复，但又怕动刀子疼，也担心对喂奶有影响，是不是得躺很久才能恢复啊？",
  "answer": "亲爱的，刚当妈妈既要照顾宝宝又想恢复身体，肯定特别辛苦吧，肚子松、有妊娠纹确实会让你没自信～ 产后修复其实是帮身体'回到正轨'的过程，不用怕，咱们一步一步来～",
  "category": "产修",
  "source": "ai_agent"
}
```

**运行方式**:
```bash
# 快速测试
python3 scripts/qa_generator_agent.py --once

# 后台运行（每20分钟生成1条）
nohup python3 scripts/qa_generator_agent.py --interval 20 > logs/qa_generator_background.log 2>&1 &
```

### 数据生成总结

| 模块 | 来源 | 方式 | 频率 | 语言 | 数据库 |
|------|------|------|------|------|--------|
| 医院 | 手工 | 脚本导入 | 一次性 | 越南语 | database.sqlite |
| 用户分享 | N8N | API接口 | 实时 | 越南语 | database.sqlite |
| 知识问答（前端） | DQA | 自动生成 | 每15分钟 | 越南语 | database.sqlite |
| 知识问答（智能体） | 大模型 | 自动生成 | 每20分钟 | 中文 | medical.db |

---

## 💾 数据库模型

### 1. 医院模型 (hospitals)

#### 必填字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `name` | VARCHAR(200) | 医院名称 | "Bệnh viện Da liễu TP.HCM" |
| `description` | TEXT | 医院描述 | "Bệnh viện chuyên khoa..." |

#### 基本信息字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `address` | VARCHAR(500) | 否 | 完整地址 |
| `city` | VARCHAR(100) | 否 | 城市（TP.HCM/Hà Nội等） |
| `district` | VARCHAR(100) | 否 | 区域 |
| `phone` | VARCHAR(50) | 否 | 联系电话 |
| `email` | VARCHAR(100) | 否 | 电子邮箱 |
| `website` | VARCHAR(500) | 否 | 官方网站 |
| `logo_url` | VARCHAR(500) | 否 | Logo URL |

#### 评价字段

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `rating` | DECIMAL(3,2) | - | 评分（4.0-4.8） |
| `review_count` | INTEGER | 0 | 评价数量 |

#### JSON数组字段

| 字段 | 类型 | 示例 |
|------|------|------|
| `images` | JSON | `["url1.jpg", "url2.jpg"]` |
| `specialties` | JSON | `["Thẩm mỹ khuôn mặt", "Nâng ngực"]` |
| `services` | JSON | `["Tiêm Botox", "Laser trị nám"]` |
| `facilities` | JSON | `["Phòng mổ vô trùng", "Máy laser"]` |
| `certifications` | JSON | `["ISO 9001", "JCI"]` |

#### 属性字段

| 字段 | 类型 | 可选值 | 说明 |
|------|------|--------|------|
| `level` | TEXT | A+, A, B | 医院等级 |
| `type` | TEXT | public/private/international | 医院类型 |
| `status` | TEXT | active/inactive | 状态 |
| `data_source` | TEXT | manual/api/n8n | 数据来源 |

#### 扩展字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `established_year` | INTEGER | 成立年份 |
| `doctors_count` | INTEGER | 医生数量 |
| `beds_count` | INTEGER | 床位数量 |

#### 完整示例

```json
{
  "name": "Bệnh viện Da liễu TP.HCM",
  "description": "Bệnh viện chuyên khoa da liễu...",
  "address": "Số 2 Nguyễn Thông, Quận 3, TP.HCM",
  "city": "TP.HCM",
  "district": "Quận 3",
  "phone": "+84 28 3930 2222",
  "email": "bvdl@hcm.gov.vn",
  "website": "https://bvdl.org.vn/",
  "rating": 4.6,
  "review_count": 856,
  "specialties": ["Thẩm mỹ khuôn mặt", "Chăm sóc da", "Tiêm Botox & Filler"],
  "services": [
    "Tiêm Botox - Xóa nhăn, nâng cơ mặt",
    "Tiêm Filler - Làm đầy rãnh nhăn",
    "Laser trị nám, tàn nhang"
  ],
  "facilities": [
    "Phòng tiêm chích vô trùng đạt chuẩn",
    "Máy laser Nd:YAG, CO2 fractional"
  ],
  "certifications": [
    "Chứng nhận bệnh viện hạng A",
    "ISO 9001:2015"
  ],
  "level": "A",
  "type": "public",
  "status": "active",
  "established_year": 1975,
  "doctors_count": 120
}
```

---

### 2. 知识问答模型 (knowledge)

#### 必填字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `question` | VARCHAR(500) | 问题内容 | "Phẫu thuật mũi có đau không?" |
| `answer` | TEXT | 答案内容 | "Không đau vì được gây tê..." |

#### 可选字段（有默认值）

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `category` | VARCHAR(100) | "Tư vấn chung" | 分类 |
| `subcategory` | VARCHAR(100) | null | 子分类 |
| `doctor_name` | VARCHAR(100) | "Bác sĩ chuyên khoa" | 医生姓名 |
| `doctor_title` | VARCHAR(100) | null | 医生职称 |
| `doctor_avatar` | VARCHAR(500) | null | 医生头像URL |
| `hospital_name` | VARCHAR(200) | null | 医院名称 |
| `difficulty_level` | ENUM | "beginner" | 难度（beginner/intermediate/advanced） |
| `status` | ENUM | "published" | 状态（draft/published/archived） |
| `source` | ENUM | "manual" | 来源（manual/api/n8n） |

#### 自动字段

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `like_count` | INTEGER | 0 | 点赞数 |
| `view_count` | INTEGER | 0 | 浏览数（详情页自动+1） |
| `external_id` | VARCHAR(100) | null | 外部系统ID（防重复） |
| `tags` | JSON | null | 标签数组 |

#### 完整示例

```json
{
  "question": "Phẫu thuật mũi cần bao lâu để phục hồi?",
  "answer": "Thời gian phục hồi khoảng 1-2 tuần cho phục hồi ban đầu...",
  "category": "Phẫu thuật mũi",
  "doctor_name": "BS Nguyễn Văn A",
  "doctor_title": "Trưởng khoa Phẫu thuật Thẩm mỹ",
  "hospital_name": "Bệnh viện thẩm mỹ TP.HCM",
  "tags": ["phẫu thuật", "mũi", "phục hồi"],
  "difficulty_level": "beginner"
}
```

#### 最简示例（N8N提交）

```json
{
  "question": "问题内容",
  "answer": "答案内容"
}
```

---

### 3. 用户分享模型 (user_shares)

#### 必填字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `title` | VARCHAR(200) | 分享标题 | "Trải nghiệm Nâng mũi Sụn sườn" |
| `content` | TEXT | 分享内容 | "Kinh nghiệm hồi phục..." |
| `author_name` | VARCHAR(100) | 作者姓名 | "匿名用户"（N8N自动填充） |

#### 可选字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `author_avatar` | VARCHAR(500) | 作者头像URL |
| `surgery_type` | VARCHAR(100) | 手术类型（智能识别） |
| `hospital_name` | VARCHAR(200) | 医院名称 |
| `rating` | INTEGER(1-5) | 评分（1-5星） |
| `images` | JSON | 图片URL数组 |
| `tags` | JSON | 标签数组 |

#### 自动字段

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `view_count` | INTEGER | 0 | 浏览数（详情页自动+1） |
| `like_count` | INTEGER | 0 | 点赞数 |
| `status` | ENUM | "published" | 状态 |
| `source` | ENUM | "manual" | 来源 |
| `external_id` | VARCHAR(100) | null | 外部系统ID |

#### 智能分类关键词

系统会自动根据标题和内容识别以下分类：

| 分类 | 关键词 |
|------|--------|
| **Phẫu thuật mũi** | mũi, nâng mũi, sụn mũi, mũi cao, thu gọn cánh mũi |
| **Phẫu thuật mắt** | mắt, mí mắt, cắt mí, bấm mí, mắt to, nhấn mí |
| **Đường nét khuôn mặt** | khuôn mặt, gọt mặt, v-line, cằm, má, hàm |
| **Thẩm mỹ cơ thể** | ngực, nâng ngực, eo, bụng, hút mỡ, giảm béo |
| **Làm đẹp da** | da, trẻ hóa, trắng da, laser, filler, botox |

#### 完整示例

```json
{
  "title": "Trải nghiệm Nâng mũi Sụn sườn tại TP.HCM",
  "content": "Chia sẻ chi tiết về quá trình phẫu thuật và phục hồi...",
  "author_name": "Chị Nguyễn",
  "surgery_type": "Phẫu thuật mũi",
  "hospital_name": "Bệnh viện thẩm mỹ TP.HCM",
  "rating": 5,
  "images": ["before.jpg", "after.jpg"],
  "tags": ["nâng mũi", "sụn sườn", "TP.HCM"]
}
```

#### 最简示例（N8N提交）

```json
{
  "title": "标题",
  "content": "内容"
}
```
自动填充：author_name="匿名用户", surgery_type=智能识别, rating=5

---

## 🚨 重要警告

### ❌ 禁止操作

1. **不要混淆数据库**
   - 前端永远使用 `database.sqlite`
   - 智能体永远使用 `medical.db`

2. **不要交叉导入**
   - ❌ 不要将 `medical.db` 的中文数据导入 `database.sqlite`
   - ❌ 不要将 `database.sqlite` 的数据导入 `medical.db`

3. **不要在前端展示中文数据**
   - 前端只展示越南语内容

4. **不要用智能体处理前端数据**
   - 智能体只处理 `medical.db` 的中文数据

5. **不要手动修改DQA生成的问答**
   - DQA系统自动运行，手动修改会被覆盖

6. **不要停止智能体服务**
   - 智能体每20分钟生成1条中文问答，停止会影响训练数据

### ✅ 正确操作

1. **前端数据操作**
   - 用户分享：通过N8N接口提交到 `database.sqlite`
   - 医院数据：通过脚本批量导入到 `database.sqlite`
   - 知识问答：由DQA自动生成到 `database.sqlite`

2. **智能体数据操作**
   - 中文问答：由拟人化智能体自动生成到 `medical.db`
   - 训练数据：仅供内部AI训练使用

---

## 🔌 API接口

### 医院 API

#### GET /api/hospitals
获取医院列表

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | 否 | 页码（默认1） |
| limit | integer | 否 | 每页数量（默认10） |
| city | string | 否 | 城市筛选 |
| type | string | 否 | 类型（public/private/international） |
| level | string | 否 | 等级（A+/A/B） |
| search | string | 否 | 搜索关键词 |
| sort | string | 否 | 排序字段（默认rating） |
| order | string | 否 | 排序方向（ASC/DESC，默认DESC） |

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 15,
      "name": "FV Hospital",
      "city": "TP.HCM",
      "rating": 4.8,
      "specialties": ["Thẩm mỹ khuôn mặt", "Trẻ hóa da"],
      ...
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 122,
    "pages": 13
  }
}
```

#### GET /api/hospitals/:id
获取医院详情

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 15,
    "name": "FV Hospital",
    "description": "Bệnh viện quốc tế...",
    "address": "6 Nguyễn Lương Bằng, Quận 7, TP.HCM",
    "phone": "+84 28 5411 3333",
    "rating": 4.8,
    "services": ["Tiêm Botox", "Laser"],
    "facilities": ["Phòng mổ vô trùng", "Máy laser"],
    "certifications": ["JCI", "ISO 9001"],
    ...
  }
}
```

---

### 知识问答 API

#### GET /api/knowledge
获取问答列表

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | 否 | 页码 |
| limit | integer | 否 | 每页数量 |
| category | string | 否 | 分类筛选 |
| search | string | 否 | 搜索关键词 |
| status | string | 否 | 状态（默认published） |

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "question": "Phẫu thuật mũi có đau không?",
      "answer": "Không đau vì được gây tê...",
      "category": "Phẫu thuật mũi",
      "doctor_name": "Bác sĩ chuyên khoa",
      "like_count": 128,
      "view_count": 256
    }
  ],
  "pagination": {...}
}
```

#### POST /api/knowledge
创建问答（完整字段）

**请求体**：
```json
{
  "question": "问题",
  "answer": "答案",
  "category": "分类",
  "doctor_name": "医生名"
}
```

#### POST /api/knowledge/n8n
N8N专用接口（最简）

**请求体**：
```json
{
  "question": "问题",
  "answer": "答案"
}
```

#### POST /api/knowledge/:id/like
点赞

**响应**：
```json
{
  "success": true,
  "message": "点赞成功",
  "data": { "like_count": 129 }
}
```

---

### 用户分享 API

#### GET /api/user-shares
获取分享列表

**请求参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | 否 | 页码 |
| limit | integer | 否 | 每页数量 |
| surgery_type | string | 否 | 手术类型筛选 |
| search | string | 否 | 搜索关键词 |
| status | string | 否 | 状态（默认published） |

#### POST /api/user-shares
创建分享（完整字段）

**请求体**：
```json
{
  "title": "标题",
  "content": "内容",
  "author_name": "作者",
  "surgery_type": "Phẫu thuật mũi",
  "hospital_name": "BV thẩm mỹ",
  "rating": 5
}
```

#### POST /api/user-shares/n8n
N8N专用接口（最简）

**请求体**：
```json
{
  "title": "标题",
  "content": "内容"
}
```

**自动填充**：
- author_name: "Người dùng ẩn danh"（匿名用户）
- surgery_type: 智能识别
- rating: 5

#### PUT /api/user-shares/:id
更新分享

#### DELETE /api/user-shares/:id
删除分享

#### POST /api/user-shares/:id/like
点赞

---

### 通用 Webhook API

#### POST /api/webhooks/n8n
通用N8N Webhook接口

**支持的type**：
- `user_share` - 用户分享
- `knowledge` - 知识问答
- `hospital` - 医院
- `service` - 服务
- `contact` - 联系

**请求体格式**：
```json
{
  "type": "knowledge",
  "data": {
    "question": "问题",
    "answer": "答案"
  }
}
```

**防重复机制**：
- 通过 `data.external_id` 字段
- 相同 external_id 会更新而非新建

#### POST /api/webhooks/batch
批量处理

**请求体**：
```json
{
  "items": [
    {
      "type": "knowledge",
      "data": {"question": "Q1", "answer": "A1"}
    },
    {
      "type": "user_share",
      "data": {"title": "T1", "content": "C1"}
    }
  ]
}
```

#### GET /api/webhooks/sync-status
查看数据统计

**响应示例**：
```json
{
  "success": true,
  "data": {
    "user_shares": 10,
    "knowledge": 15,
    "hospitals": 122,
    "services": 0,
    "contacts": 5
  }
}
```

---

## 🔗 N8N集成指南

### 推荐接口对比

| 功能 | 推荐接口 | 数据格式 | 优势 |
|------|---------|---------|------|
| **知识问答** | `/api/knowledge/n8n` | `{question, answer}` | 最简单，2个字段 |
| **用户分享** | `/api/user-shares/n8n` | `{title, content}` | 最简单，2个字段 + 智能分类 |
| **混合类型** | `/api/webhooks/n8n` | `{type, data}` | 统一接口，支持多类型 |

### 使用示例

#### 1. 提交知识问答（最简）

```bash
curl -X POST http://47.237.79.9:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "question": "Phẫu thuật mũi có đau không?",
    "answer": "Không đau vì được gây tê hoặc gây mê."
  }'
```

#### 2. 提交用户分享（最简）

```bash
curl -X POST http://47.237.79.9:5002/api/user-shares/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Trải nghiệm nâng mũi tại TP.HCM",
    "content": "Chia sẻ kinh nghiệm phục hồi sau phẫu thuật..."
  }'
```

#### 3. 使用通用Webhook

```bash
curl -X POST http://47.237.79.9:5002/api/webhooks/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "type": "knowledge",
    "data": {
      "question": "问题",
      "answer": "答案"
    }
  }'
```

#### 4. 批量提交

```bash
curl -X POST http://47.237.79.9:5002/api/webhooks/batch \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {"type": "knowledge", "data": {"question": "Q1", "answer": "A1"}},
      {"type": "user_share", "data": {"title": "T1", "content": "C1"}}
    ]
  }'
```

---

## 🌐 前端页面

### 医院模块

#### 列表页：/reviews
- **地址**: http://47.237.79.9:5001/reviews
- **功能**:
  - 3列网格展示
  - 城市筛选（5个城市）
  - 动态星级显示
  - 分页导航（36家/页）
  - 浏览数显示

**城市筛选URL**：
- 全部：`/reviews`
- 胡志明：`/reviews?city=TP.HCM`
- 河内：`/reviews?city=Hà%20Nội`
- 岘港：`/reviews?city=Đà%20Nẵng`
- 海防：`/reviews?city=Hải%20Phòng`
- 芹苴：`/reviews?city=Cần%20Thơ`

#### 详情页：/reviews/[id]
- **地址**: http://47.237.79.9:5001/reviews/15
- **内容**:
  - 医院基本信息
  - 联系方式（电话、邮箱、网站）
  - 4个媒体块（服务、设施、认证、评价）
  - 相关医院推荐

---

### 知识问答模块

#### 列表页：/knowledge
- **地址**: http://47.237.79.9:5001/knowledge
- **功能**:
  - 3列网格展示
  - 问题和答案预览
  - 医生信息
  - 点赞数、浏览数
  - 分页导航

#### 详情页：/knowledge/[id]
- **地址**: http://47.237.79.9:5001/knowledge/1
- **内容**:
  - 完整问题和答案
  - 医生信息
  - 点赞功能
  - 相关问题推荐

---

### 用户分享模块

#### 列表页：/sharing
- **地址**: http://47.237.79.9:5001/sharing
- **功能**:
  - 3列网格展示
  - 标题和内容预览
  - 点赞数、浏览数
  - 手术类型标签
  - 分页导航

#### 详情页：/sharing/[id]
- **地址**: http://47.237.79.9:5001/sharing/1
- **内容**:
  - 完整分享内容
  - 手术信息
  - 点赞功能
  - 相关分享推荐

---

## 🛠️ 配置方法

### 1. 添加医院数据

#### 方法A：通过脚本批量添加

创建脚本文件：
```javascript
// backend/src/scripts/add-hospitals.js
import { models } from '../models/index.js';
const { Hospital } = models;

const hospitals = [
  {
    name: '医院名称',
    description: '医院描述',
    address: '完整地址',
    city: 'TP.HCM',
    district: 'Quận 1',
    phone: '+84 28 xxxx xxxx',
    email: 'email@hospital.vn',
    website: 'https://hospital.vn',
    rating: 4.5,
    review_count: 1000,
    specialties: ['专科1', '专科2'],
    services: ['服务1', '服务2'],
    facilities: ['设施1', '设施2'],
    certifications: ['认证1', '认证2'],
    level: 'A',
    type: 'private',
    status: 'active',
    data_source: 'manual'
  }
];

async function addHospitals() {
  for (const data of hospitals) {
    await Hospital.create(data);
    console.log(`✅ 已添加: ${data.name}`);
  }
  process.exit(0);
}

addHospitals();
```

运行脚本：
```bash
cd /root/越南医疗整形项目/backend
node src/scripts/add-hospitals.js
```

#### 方法B：通过N8N Webhook

```bash
curl -X POST http://47.237.79.9:5002/api/webhooks/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "type": "hospital",
    "data": {
      "name": "医院名称",
      "description": "描述",
      "city": "TP.HCM",
      ...
    }
  }'
```

---

### 2. 添加知识问答

#### 方法A：N8N专用接口（推荐）

```bash
curl -X POST http://47.237.79.9:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "question": "问题",
    "answer": "答案"
  }'
```

#### 方法B：标准API接口

```bash
curl -X POST http://47.237.79.9:5002/api/knowledge \
  -H "Content-Type: application/json" \
  -d '{
    "question": "问题",
    "answer": "答案",
    "category": "分类",
    "doctor_name": "医生名"
  }'
```

---

### 3. 添加用户分享

#### 方法A：N8N专用接口（推荐）

```bash
curl -X POST http://47.237.79.9:5002/api/user-shares/n8n \
  -H "Content-Type: application/json" \
  -d '{
    "title": "标题",
    "content": "内容"
  }'
```

**自动功能**：
- ✅ 作者名自动填充为"匿名用户"
- ✅ 手术类型智能识别
- ✅ 评分默认5星

#### 方法B：标准API接口

```bash
curl -X POST http://47.237.79.9:5002/api/user-shares \
  -H "Content-Type: application/json" \
  -d '{
    "title": "标题",
    "content": "内容",
    "author_name": "作者",
    "surgery_type": "Phẫu thuật mũi",
    "rating": 5
  }'
```

---

## 📊 数据查询

### 1. 查询所有数据

```bash
# 查询所有医院
curl http://47.237.79.9:5002/api/hospitals

# 查询所有知识问答
curl http://47.237.79.9:5002/api/knowledge

# 查询所有用户分享
curl http://47.237.79.9:5002/api/user-shares
```

### 2. 按条件筛选

```bash
# 按城市查询医院
curl "http://47.237.79.9:5002/api/hospitals?city=TP.HCM"

# 按分类查询问答
curl "http://47.237.79.9:5002/api/knowledge?category=Phẫu%20thuật%20mũi"

# 按手术类型查询分享
curl "http://47.237.79.9:5002/api/user-shares?surgery_type=Phẫu%20thuật%20mũi"
```

### 3. 搜索

```bash
# 搜索医院
curl "http://47.237.79.9:5002/api/hospitals?search=FV"

# 搜索问答
curl "http://47.237.79.9:5002/api/knowledge?search=phẫu%20thuật"
```

### 4. 直接查询数据库

```bash
# 进入数据库
sqlite3 /root/越南医疗整形项目/backend/data/medical.db

# 查询医院
SELECT id, name, city, rating FROM hospitals LIMIT 10;

# 统计各城市医院数
SELECT city, COUNT(*) FROM hospitals GROUP BY city;

# 查询知识问答
SELECT id, question, category FROM knowledge LIMIT 10;

# 查询用户分享
SELECT id, title, surgery_type FROM user_shares LIMIT 10;
```

---

## 🚀 部署运维

### 服务管理

#### 查看服务状态
```bash
# 前端服务
systemctl status vietnam-medical.service

# 后端服务
systemctl status vietnam-medical-backend.service
```

#### 重启服务
```bash
# 重启前端
systemctl restart vietnam-medical.service

# 重启后端
systemctl restart vietnam-medical-backend.service

# 同时重启
systemctl restart vietnam-medical.service vietnam-medical-backend.service
```

#### 查看日志
```bash
# 前端日志
journalctl -u vietnam-medical.service -f

# 后端日志
journalctl -u vietnam-medical-backend.service -f
```

### 完整部署

```bash
cd /root/越南医疗整形项目
./deploy.sh
```

部署脚本会自动：
1. 停止服务
2. 安装依赖
3. 构建前端
4. 配置systemd
5. 启动服务
6. 健康检查

---

## 📁 项目结构

```
越南医疗整形项目/
├── backend/                    # 后端代码
│   ├── src/
│   │   ├── api/               # API路由
│   │   │   ├── hospitalRoutes.js
│   │   │   ├── knowledgeRoutes.js
│   │   │   ├── userShareRoutes.js
│   │   │   ├── webhookRoutes.js
│   │   │   └── routes.js
│   │   ├── models/            # 数据模型
│   │   │   ├── Hospital.js
│   │   │   ├── Knowledge.js
│   │   │   ├── UserShare.js
│   │   │   └── index.js
│   │   ├── scripts/           # 数据脚本
│   │   │   └── add-hospitals.js
│   │   ├── utils/             # 工具函数
│   │   └── server.js          # 服务入口
│   ├── data/
│   │   ├── database.sqlite    # 前端越南语网站数据库
│   │   └── medical.db         # 智能体中文训练数据库
│   └── package.json
├── src/                       # 前端代码
│   ├── pages/
│   │   ├── reviews.astro      # 医院列表
│   │   ├── reviews/[id].astro # 医院详情
│   │   ├── knowledge.astro    # 知识问答列表
│   │   ├── knowledge/[id].astro
│   │   ├── sharing.astro      # 用户分享列表
│   │   └── sharing/[id].astro
│   ├── layouts/
│   ├── components/
│   ├── styles/
│   └── utils/
│       └── api.js             # API调用工具
├── docs/                      # 文档
│   ├── 数据库配置开发文档.md  # 本文档
│   ├── 数据库配置完整文档.md  # 完整文档
│   ├── DQA拟人化优化总结-v1.5.0.md
│   ├── 拟人化问答生成智能体使用指南.md
│   └── 知识问答功能配置完成.md
├── scripts/                   # 脚本
│   ├── qa_generator_agent.py # 拟人化问答生成智能体
│   └── test-personalized-dqa.js # DQA拟人化测试脚本
├── logs/                      # 日志
│   ├── qa_generator.log       # 智能体运行日志
│   └── qa_generator_background.log # 智能体后台日志
├── deploy.sh                  # 部署脚本
└── package.json
```

---

## 🎯 常用操作

### 添加新医院

1. 创建脚本 `/backend/src/scripts/add-my-hospital.js`
2. 定义医院数据（参考上面的完整示例）
3. 运行脚本：`node src/scripts/add-my-hospital.js`
4. 重启后端：`systemctl restart vietnam-medical-backend.service`
5. 重启前端：`systemctl restart vietnam-medical.service`

### 批量导入问答

1. 准备JSON数据文件
2. 使用批量接口提交
3. 或创建脚本循环插入

### 更新医院评分

```bash
sqlite3 /root/越南医疗整形项目/backend/data/medical.db

UPDATE hospitals SET rating = 4.7 WHERE id = 15;
```

### 查看数据统计

```bash
curl http://47.237.79.9:5002/api/webhooks/sync-status
```

---

## 🔍 故障排查

### 1. 前端页面显示旧数据

**原因**：浏览器缓存  
**解决**：清除缓存 `Ctrl + Shift + R`

### 2. API返回空数据

**检查**：
```bash
# 检查后端服务
systemctl status vietnam-medical-backend.service

# 检查数据库
sqlite3 /root/越南医疗整形项目/backend/data/medical.db "SELECT COUNT(*) FROM hospitals;"
```

### 3. N8N提交失败

**检查**：
- URL是否正确
- Content-Type是否为application/json
- 数据格式是否正确
- 查看后端日志：`journalctl -u vietnam-medical-backend.service -f`

### 4. 服务无法启动

**检查**：
```bash
# 查看详细错误
journalctl -u vietnam-medical-backend.service -n 50

# 检查端口占用
netstat -tlnp | grep 5002
```

---

## 📝 最佳实践

### 1. 数据录入

✅ **推荐**：
- 医院数据：通过脚本批量添加
- 知识问答：通过N8N专用接口
- 用户分享：通过N8N专用接口

❌ **不推荐**：
- 直接操作数据库（容易出错）
- 手动拼接SQL（不安全）

### 2. 字段要求

**医院数据**：
- ✅ 必须提供：name, description
- ✅ 推荐提供：city, address, phone, website
- ✅ 详细信息：services, facilities, certifications（各6-7项）

**知识问答**：
- ✅ 必须提供：question, answer
- ✅ 推荐提供：category（便于筛选）

**用户分享**：
- ✅ 必须提供：title, content
- ✅ 自动填充：author_name, surgery_type, rating

### 3. 评分设置

**评分范围**：
- 胡志明市、河内：4.2 - 4.8
- 岘港、海防、芹苴：4.0 - 4.5

**分布建议**：
- 4.7-4.8分：10%（顶级医院）
- 4.4-4.6分：50%（主流医院）
- 4.0-4.3分：40%（普通医院）

---

## 🔐 安全注意

1. **API访问**：已配置CORS，仅允许特定域名
2. **限流**：每个IP 15分钟最多100次请求
3. **数据验证**：所有输入都经过Joi验证
4. **SQL注入防护**：使用Sequelize ORM
5. **XSS防护**：使用helmet中间件

---

## 📞 技术支持

### 健康检查
```bash
curl http://47.237.79.9:5002/health
```

### API信息
```bash
curl http://47.237.79.9:5002/api/info
```

### 数据统计
```bash
curl http://47.237.79.9:5002/api/webhooks/sync-status
```

---

## 🎉 快速开始

### 1分钟快速测试

```bash
# 1. 添加一条知识问答
curl -X POST http://47.237.79.9:5002/api/knowledge/n8n \
  -H "Content-Type: application/json" \
  -d '{"question":"测试问题","answer":"测试答案"}'

# 2. 查看结果
curl http://47.237.79.9:5002/api/knowledge

# 3. 前端查看
浏览器访问：http://47.237.79.9:5001/knowledge
```

---

## ❓ 常见问题

### Q1: 知识问答数据从哪来？
**A**: 知识问答由**双重系统**生成：
- **DQA系统**: 每15分钟生成1条越南语医院问答，基于122家医院真实数据，存储到 `database.sqlite`，前端展示
- **拟人化智能体**: 每20分钟生成1条中文医美问答，基于大模型生成，存储到 `medical.db`，仅供内部训练

### Q2: 如何查看DQA生成进度？
**A**: 访问 `http://localhost:5002/api/dqa/stats` 查看统计，或查看数据库：
```bash
sqlite3 /root/越南医疗整形项目/backend/data/database.sqlite \
  "SELECT COUNT(*) FROM knowledge WHERE source='dqa';"
```

### Q3: 如何查看智能体生成进度？
**A**: 查看智能体日志和数据库：
```bash
# 查看智能体日志
tail -f /root/越南医疗整形项目/logs/qa_generator.log

# 查看最近生成的中文问答
sqlite3 /root/越南医疗整形项目/backend/data/medical.db \
  "SELECT COUNT(*) FROM knowledge WHERE created_at > datetime('now', '-1 day');"
```

### Q4: 用户分享数据如何添加？
**A**: 通过N8N接口提交：
```bash
curl -X POST http://47.237.79.9:5002/api/user-shares/n8n \
  -H "Content-Type: application/json" \
  -d '{"title":"标题","content":"内容"}'
```

### Q5: 两个数据库有什么区别？
**A**: 
- `database.sqlite`: 前端越南语网站数据，用户可见，包含DQA生成的越南语问答
- `medical.db`: 后端中文智能体数据，仅供AI训练，用户不可见，包含智能体生成的中文问答

### Q6: 如何启动/停止智能体服务？
**A**:
```bash
# 启动智能体（后台运行）
nohup python3 scripts/qa_generator_agent.py --interval 20 > logs/qa_generator_background.log 2>&1 &

# 停止智能体
ps aux | grep qa_generator_agent
kill <PID>
```

### Q7: 如何备份数据？
**A**:
```bash
# 备份前端数据库
cp /root/越南医疗整形项目/backend/data/database.sqlite \
   /root/越南医疗整形项目/backend/data/database.sqlite.$(date +%Y%m%d).bak

# 备份智能体数据库
cp /root/越南医疗整形项目/backend/data/medical.db \
   /root/越南医疗整形项目/backend/data/medical.db.$(date +%Y%m%d).bak
```

### Q8: DQA和智能体生成的问答有什么区别？
**A**:
- **DQA问答**: 基于医院真实数据，越南语，拟人化表达（v1.5.0优化），前端展示
- **智能体问答**: 基于大模型生成，中文，高度拟人化，患者视角，仅供内部训练

---

**文档版本**: v3.0  
**最后更新**: 2025-10-26  
**维护者**: 开发团队  
**重要更新**: 
- ✅ 数据库分离完成
- ✅ DQA+智能体双重问答生成系统
- ✅ 完整的系统架构说明  
**状态**: ✅ 生产环境运行中

