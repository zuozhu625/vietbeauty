---
import Layout from '../../layouts/Layout.astro';
import '../../styles/global.css';
import { knowledgeAPI } from '../../utils/api.js';

// è·å–è·¯ç”±å‚æ•°
const { id } = Astro.params;

// çº¯SSRæ¨¡å¼ï¼šæ¯æ¬¡è¯·æ±‚æ—¶åŠ¨æ€è·å–æ•°æ®
let knowledgeDetail = null;
try {
  const response = await knowledgeAPI.getDetail(id);
  knowledgeDetail = response.data;
} catch (error) {
  console.error('è·å–é—®ç­”è¯¦æƒ…å¤±è´¥:', error);
}

// å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œè¿”å›404
if (!knowledgeDetail) {
  return Astro.redirect('/404');
}

// è·å–ç›¸å…³é—®ç­”ï¼ˆåŒåˆ†ç±»ï¼Œæ’é™¤å½“å‰é—®ç­”ï¼Œæœ€å¤š6æ¡ï¼‰
let relatedKnowledge = [];
try {
  const relatedResponse = await knowledgeAPI.getList({ 
    category: knowledgeDetail.category,
    limit: 7,
    status: 'published'
  });
  relatedKnowledge = (relatedResponse.data || []).filter(item => item.id.toString() !== id).slice(0, 6);
} catch (error) {
  console.error('è·å–ç›¸å…³é—®ç­”å¤±è´¥:', error);
}

// ç”ŸæˆSEOä¼˜åŒ–çš„Metaä¿¡æ¯
const pageTitle = `${knowledgeDetail.question} | Há»i Ä‘Ã¡p pháº«u thuáº­t tháº©m má»¹`;
const pageDescription = knowledgeDetail.answer 
  ? knowledgeDetail.answer.substring(0, 155).replace(/\n/g, ' ') + '...'
  : `BÃ¡c sÄ© ${knowledgeDetail.doctor_name || 'chuyÃªn khoa'} giáº£i Ä‘Ã¡p: ${knowledgeDetail.question}`;

// ç”Ÿæˆå…³é”®è¯ï¼šé—®é¢˜åˆ†ç±» + åŒ»é™¢å + ç›¸å…³æ ‡ç­¾
const keywords = [
  knowledgeDetail.category,
  knowledgeDetail.question.split(' ').slice(0, 5).join(' '), // é—®é¢˜å‰5ä¸ªè¯
  knowledgeDetail.hospital_name || 'tÆ° váº¥n bá»‡nh viá»‡n',
  'há»i Ä‘Ã¡p bÃ¡c sÄ©',
  'tÆ° váº¥n miá»…n phÃ­',
  'pháº«u thuáº­t tháº©m má»¹',
  ...(knowledgeDetail.tags || [])
].filter(Boolean).join(', ');

// æ ¼å¼åŒ–å‘å¸ƒæ—¶é—´ç”¨äºç»“æ„åŒ–æ•°æ®
const publishedTime = knowledgeDetail.created_at 
  ? new Date(knowledgeDetail.created_at).toISOString()
  : undefined;
const modifiedTime = knowledgeDetail.updated_at 
  ? new Date(knowledgeDetail.updated_at).toISOString()
  : undefined;
---

<Layout 
  title={pageTitle}
  description={pageDescription}
  keywords={keywords}
  type="article"
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  articleAuthor={knowledgeDetail.doctor_name || 'BÃ¡c sÄ© chuyÃªn khoa'}
>
  <!-- è¿”å›æŒ‰é’® -->
  <section class="pt-24 pb-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <a href="/knowledge" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Quay láº¡i danh sÃ¡ch há»i Ä‘Ã¡p
      </a>
    </div>
  </section>

  <!-- ä¸»è¦å†…å®¹ -->
  <section class="pb-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
      <div class="glass rounded-2xl p-6 lg:p-8">
        <!-- é—®é¢˜éƒ¨åˆ† -->
        <div class="mb-8">
          <div class="flex items-start mb-6">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center text-white font-bold mr-4 flex-shrink-0">
              Q
            </div>
            <div class="flex-1">
              <h1 class="text-white font-bold text-xl lg:text-2xl leading-tight mb-3">
                {knowledgeDetail.question}
              </h1>
              <div class="flex flex-wrap items-center gap-4 text-sm text-white/60">
                <span>NgÆ°á»i há»i: {knowledgeDetail.questioner_name}</span>
                <span>â€¢</span>
                <span>{knowledgeDetail.questioner_age} tuá»•i</span>
                <span>â€¢</span>
                <span>{knowledgeDetail.created_at ? new Date(knowledgeDetail.created_at).toLocaleDateString('vi-VN') : 'NgÃ y khÃ´ng xÃ¡c Ä‘á»‹nh'}</span>
                <span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-md">
                  {knowledgeDetail.category}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- åŒ»ç”Ÿå›ç­”éƒ¨åˆ† -->
        <div class="bg-white/5 rounded-xl p-6 border-l-4 border-green-400 mb-8">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-gradient-to-r from-green-400 to-blue-400 rounded-full flex items-center justify-center text-white font-bold mr-4">
              A
            </div>
            <div>
              <h2 class="text-white font-bold text-lg">{knowledgeDetail.doctor_name}</h2>
              <p class="text-white/80 text-sm">{knowledgeDetail.doctor_title}</p>
              <p class="text-white/60 text-sm">{knowledgeDetail.doctor_hospital}</p>
              <p class="text-green-400 text-xs">{knowledgeDetail.doctor_experience}</p>
            </div>
          </div>
          
          <div class="prose prose-invert max-w-none">
            <p class="text-white/90 leading-relaxed whitespace-pre-line">{knowledgeDetail.answer}</p>
          </div>
          
          <div class="mt-4 pt-4 border-t border-white/10">
            <p class="text-white/60 text-sm">
              Tráº£ lá»i ngÃ y: {knowledgeDetail.updated_at ? new Date(knowledgeDetail.updated_at).toLocaleDateString('vi-VN') : 'NgÃ y khÃ´ng xÃ¡c Ä‘á»‹nh'}
            </p>
          </div>
        </div>

        <!-- äº’åŠ¨ç»Ÿè®¡ -->
        <div class="flex items-center justify-between py-6 border-t border-white/10 border-b border-white/10 mb-8">
          <div class="flex items-center space-x-6">
            <button class="flex items-center text-white/60 hover:text-green-400 transition-colors">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
              </svg>
              {knowledgeDetail.like_count} há»¯u Ã­ch
            </button>
            <span class="flex items-center text-white/60">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              {knowledgeDetail.view_count} lÆ°á»£t xem
            </span>
          </div>
          <div class="flex space-x-2">
            <button 
              id="shareButton"
              class="btn-primary px-6 py-2 text-sm"
              onclick="
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                  const btn = document.getElementById('shareButton');
                  const originalText = btn.innerHTML;
                  btn.innerHTML = 'âœ… ÄÃ£ sao chÃ©p liÃªn káº¿t';
                  btn.classList.add('bg-green-500');
                  setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-500');
                  }, 2000);
                });
              "
            >
              ğŸ”— Chia sáº»
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ç›¸å…³é—®ç­”æ¨è -->
  {relatedKnowledge.length > 0 && (
    <section class="pb-20 px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold gradient-text-blue mb-4">CÃ¢u há»i liÃªn quan</h2>
          <p class="text-white/70">CÃ¡c cÃ¢u há»i khÃ¡c trong cÃ¹ng chá»§ Ä‘á»</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {relatedKnowledge.map((item) => (
            <div class="media-card h-[340px] flex flex-col">
              <!-- æ ‡é¢˜åŒºåŸŸ -->
              <div class="flex-shrink-0 mb-4">
                <div class="flex items-start justify-between mb-3">
                  <span class="bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full text-xs font-semibold">
                    {item.category}
                  </span>
                </div>
                <h3 class="text-white font-bold text-lg line-clamp-2 h-14 leading-tight">
                  {item.question}
                </h3>
              </div>
              
              <!-- å›ç­”é¢„è§ˆ -->
              <div class="flex-shrink-0 mb-4">
                <p class="text-white/70 text-sm line-clamp-3 h-16 leading-relaxed">
                  {item.answer}
                </p>
              </div>
              
              <!-- åº•éƒ¨ä¿¡æ¯ - è‡ªåŠ¨æ¨åˆ°åº•éƒ¨ -->
              <div class="mt-auto flex-shrink-0 pt-4 border-t border-white/10">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-4 text-white/60 text-sm">
                    <span class="flex items-center gap-1">
                      ğŸ‘ {item.like_count || 0}
                    </span>
                    <span class="flex items-center gap-1">
                      ğŸ‘ï¸ {item.view_count || 0}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 flex-1 justify-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center text-white text-xs font-bold">
                      BS
                    </div>
                    <span class="text-white/80 text-sm truncate max-w-[100px]">
                      {item.doctor_name || 'BÃ¡c sÄ©'}
                    </span>
                  </div>
                  <a 
                    href={`/knowledge/${item.id}`}
                    class="text-blue-400 hover:text-blue-300 transition-colors text-sm font-medium whitespace-nowrap"
                  >
                    Chi tiáº¿t â†’
                  </a>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>

<script>
  // å¤åˆ¶é“¾æ¥åŠŸèƒ½å·²å†…è”åœ¨æŒ‰é’®çš„onclickä¸­
</script>